<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>إدارة الدرجات الأكاديمية المطورة</title>
    <link rel="manifest" href="manifest.json">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Noto+Naskh+Arabic:wght@400;700&display=swap">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script> <style>
        :root {
            --primary-color: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --text-color: #212529;
            --bg-color: #eef2f7;
            --container-bg: #ffffff;
            --border-color: #dee2e6;
            --table-header-bg: #f1f3f5;
            --table-row-even-bg: #f9fafb;
            --table-sticky-bg: #fdfdfe;
            --table-sticky-header-bg: #e9ecef;
            --grade-fail-bg: #ffebee; --grade-fail-text: #c62828;
            --grade-excellent-bg: #e8f5e9; --grade-excellent-text: #2e7d32;
            --s1-final-bg-base: #FFF9C4; 
            --s2-final-bg-base: #FFF9C4;
            --annual-effort-bg-base: #E0F2F1; 
            --overall-final-bg-base: #E3F2FD; 
            --elementary-color: #3498db; 
            --elementary-hover: #2980b9;
            --intermediate-color: #e67e22; 
            --intermediate-hover: #d35400;
            --secondary-color-theme: #8e44ad; 
            --secondary-hover: #732d91;
            --academic-border: #d1d8e0;
            --academic-header-bg: #004085; 
            --header-text-color: #ffffff; 
            --developer-button-gold: #FFD700;
            --developer-button-gold-dark: #DAA520;
            --hamburger-color: var(--primary-color);
            --input-readonly-bg: #e9ecef; 
        }

        body.dark-mode {
            --primary-color: #4dabf7;
            --secondary-color: #868e96;
            --success-color: #40c057;
            --danger-color: #fa5252;
            --warning-color: #fcc419;
            --info-color: #3bc9db;
            --light-color: #343a40; 
            --dark-color: #f8f9fa;  
            --text-color: #e9ecef;  
            --bg-color: #121212;    
            --container-bg: #1e1e1e; 
            --border-color: #495057; 
            --table-header-bg: #2c2c2c;
            --table-row-even-bg: #252525;
            --table-sticky-bg: #252525; 
            --table-sticky-header-bg: #303030; 
            --academic-header-bg: #003366; 
            --header-text-color: #e9ecef;
            --grade-fail-bg: #5c1a1a; --grade-fail-text: #ff8787;
            --grade-excellent-bg: #1b4b1f; --grade-excellent-text: #96f29b;
            --s1-final-bg-base: #595537; 
            --s2-final-bg-base: #595537;
            --annual-effort-bg-base: #2a504e; 
            --overall-final-bg-base: #2c4858;
            --hamburger-color: var(--primary-color);
            --input-readonly-bg: #2c3034; 
        }
        
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-color); 
            color: var(--text-color);
            font-size: 16px;
            user-select: none; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none;
            line-height: 1.7; 
            display: flex; flex-direction: column;
            position: relative;
            transition: background-color 0.3s ease, color 0.3s ease; 
        }
        body.noscroll-page-active,
        body.modal-open,
        body.table-editing-mode {
            overflow: hidden !important; 
        }
        
        .academic-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--academic-header-bg) 100%);
            padding: 15px 0; 
            margin-bottom: 0; 
            border-bottom: 3px solid var(--developer-button-gold-dark); 
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
            position: relative; 
            flex-shrink: 0; 
            z-index: 100; 
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        
        .header-title {
            color: var(--header-text-color);
            font-size: 1.8rem; 
            font-weight: 700;
            text-align: center;
            margin: 0;
            padding: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2); 
        }
        
        .page { 
            display: none !important; 
            flex-grow: 1; 
            width: 100%; 
            flex-direction: column; 
            overflow: hidden; 
        } 
        .page.active { 
            display: flex !important; 
        }
        .page .container {
             overflow-y: auto; 
             height: 100%; 
        }

        .btn {
            padding: 6px 12px; 
            color: white; border: none; border-radius: 6px; 
            cursor: pointer; font-size: 0.85rem; 
            transition: all 0.3s ease; 
            margin: 4px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.1);
            font-weight: 500;
            text-align: center;
            white-space: nowrap; 
        }
        #page-grades-table .actions-bar .btn {
             padding: 8px 12px; 
             font-size: 0.9rem;
        }


        body.dark-mode .btn {
            color: var(--dark-color); 
        }
        body.dark-mode .btn-primary, 
        body.dark-mode .btn-secondary,
        body.dark-mode .btn-success,
        body.dark-mode .btn-danger,
        body.dark-mode .btn-info,
        body.dark-mode .btn-elementary,
        body.dark-mode .btn-intermediate,
        body.dark-mode .btn-secondary-stage {
             color: white; 
        }
        body.dark-mode .btn-light {
            background-color: var(--light-color); 
            color: var(--dark-color); 
            border-color: var(--border-color);
        }
         body.dark-mode .btn-warning {
            background-color: var(--warning-color);
            color: #333; 
        }


        .btn:hover { 
            box-shadow: 0 3px 7px rgba(0,0,0,0.18), 0 2px 5px rgba(0,0,0,0.13);
            transform: translateY(-1px); 
        }
        .btn:active {
            transform: translateY(0px);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
        }
        .btn:disabled { background-color: var(--secondary-color); cursor: not-allowed; opacity: 0.6; transform: none; box-shadow: none; }
        .btn-primary { background-color: var(--primary-color); } .btn-primary:hover { background-color: color-mix(in srgb, var(--primary-color) 90%, black); }
        .btn-secondary { background-color: var(--secondary-color); } .btn-secondary:hover { background-color: color-mix(in srgb, var(--secondary-color) 90%, black); }
        .btn-success { background-color: var(--success-color); } .btn-success:hover { background-color: color-mix(in srgb, var(--success-color) 90%, black); }
        .btn-danger { background-color: var(--danger-color); } .btn-danger:hover { background-color: color-mix(in srgb, var(--danger-color) 90%, black); }
        .btn-info { background-color: var(--info-color); } .btn-info:hover { background-color: color-mix(in srgb, var(--info-color) 90%, black); }
        .btn-warning { background-color: var(--warning-color); color: var(--text-color); } .btn-warning:hover { background-color: color-mix(in srgb, var(--warning-color) 90%, black); }
        .btn-light { background-color: var(--light-color); color: var(--text-color); border: 1px solid var(--border-color);}
        .btn-light:hover { background-color: color-mix(in srgb, var(--light-color) 90%, #888); }
        
        .btn-stage, .btn-grade-option { 
            display: block; width: 90%; max-width: 450px; 
            margin: 15px auto !important; 
            padding: 22px !important; font-size: 1.25rem !important; font-weight: bold; 
            text-align: center; border-radius: 10px; 
        }
        .btn-elementary { background-color: var(--elementary-color); } .btn-elementary:hover { background-color: var(--elementary-hover); }
        .btn-intermediate { background-color: var(--intermediate-color); } .btn-intermediate:hover { background-color: var(--intermediate-hover); }
        .btn-secondary-stage { background-color: var(--secondary-color-theme); } .btn-secondary-stage:hover { background-color: var(--secondary-hover); }

        .container {
            margin: 10px auto; 
            padding: 15px; 
            background-color: var(--container-bg); 
            border-radius: 10px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); 
            width: 95%; max-width: 1200px; 
            box-sizing: border-box; 
            display: flex; flex-direction: column; 
            border: 1px solid var(--academic-border);
        }
        
        #page-grades-table.page { 
            padding: 0; 
            margin: 0;
            max-width: 100%;
            width: 100%;
            border: none;
            box-shadow: none;
            background-color: transparent; 
        }
        
        .in-grades-page .grades-table-content-wrapper { 
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            background-color: var(--container-bg);
            transition: all 0.3s ease-out; 
        }

        #page-main-selection.container,
        #page-elementary-grades.container,
        #page-intermediate-grades.container,
        #page-secondary-branches.container,
        #page-secondary-grades.container,
        #page-grade-options.container,
        #page-actual-section-management .container-content { 
            display: flex;
            flex-direction: column;
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            flex-grow: 1; 
        }
        /* === التصميم الجديد لصفحة خيارات الصف === */
        .actions-grid-new {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem auto;
        }
        .action-card-new {
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 1.5rem 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            min-height: 120px;
            cursor: pointer;
            font-family: 'Tajawal', sans-serif;
        }
        .action-card-new:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }
        .action-icon-new {
            font-size: 2.5rem;
            line-height: 1;
            margin-bottom: 0.75rem;
            color: white;
        }
        .action-text-new {
            font-size: 1rem;
            font-weight: 600;
            line-height: 1.3;
            color: white;
        }

        /* ألوان أكاديمية للبطاقات الجديدة */
        .btn-academic-blue { background-color: #3498db; }
        .btn-academic-blue:hover { background-color: #2980b9; }

        .btn-academic-teal { background-color: #1abc9c; }
        .btn-academic-teal:hover { background-color: #16a085; }

        .btn-academic-green { background-color: #2ecc71; }
        .btn-academic-green:hover { background-color: #27ae60; }

        .btn-academic-gray { background-color: #6666FF; }
        .btn-academic-gray:hover { background-color: #7f8c8d; }

        /* تعديلات ألوان الوضع الليلي */
        body.dark-mode .action-card-new:hover {
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }
        body.dark-mode .btn-academic-blue { background-color: #2980b9; }
        body.dark-mode .btn-academic-blue:hover { background-color: #3498db; }
        body.dark-mode .btn-academic-teal { background-color: #16a085; }
        body.dark-mode .btn-academic-teal:hover { background-color: #1abc9c; }
        body.dark-mode .btn-academic-green { background-color: #27ae60; }
        body.dark-mode .btn-academic-green:hover { background-color: #2ecc71; }
        body.dark-mode .btn-academic-gray { background-color: #7f8c8d; }
        body.dark-mode .btn-academic-gray:hover { background-color: #95a5a6; }

        /* لجعل التصميم متجاوباً على الشاشات الصغيرة */
        @media (max-width: 480px) {
            .actions-grid-new {
                grid-template-columns: repeat(2, 1fr);
            }
            .action-card-new {
                padding: 1rem;
                min-height: 110px;
            }
            .action-icon-new {
                font-size: 2rem;
            }
            .action-text-new {
                font-size: 0.9rem;
            }
        }
         #page-actual-section-management .container-content {
            /* تعديلات جديدة لتثبيت التخطيط */
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        #page-main-selection .btn, #page-elementary-grades .btn, #page-intermediate-grades .btn,
        #page-secondary-branches .btn, #page-secondary-grades .btn { 
            margin-left: auto; margin-right: auto; 
        }
        
        h1, h2, h3 { text-align: center; color: var(--dark-color); margin-bottom: 1rem; } 
        h1.page-main-title { 
            font-size: 1.6rem; 
            font-weight: 700;
            color: var(--primary-color); 
            margin-bottom: 0.75rem; 
            padding-bottom: 0.4rem; 
            border-bottom: 2px solid var(--border-color); 
            width: auto; 
            display: inline-block; 
        } 
        h2 { font-size: 1.4rem; }  h3 { font-size: 1.1rem; } 
        
        .main-selection-title { 
            font-family: 'Noto Naskh Arabic', 'Tajawal', sans-serif;
            color: var(--primary-color);
            font-size: 1.7rem; 
            font-weight: 700;
            margin-bottom: 1.5rem; 
        }
        /* الإطار الأكاديمي للعنوان الديناميكي */
        .dynamic-title-frame {
            width: 90%;
            max-width: 450px;
            padding: 12px 20px;
            margin: 1.5rem auto 1rem auto;
            background-color: var(--container-bg);
            border: 1px solid var(--border-color);
            border-right: 5px solid var(--primary-color);
            border-radius: 8px;
            color: var(--primary-color);
            font-size: 1.25rem;
            font-weight: 700;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        body.dark-mode .dynamic-title-frame {
            background-color: var(--light-color);
            border-color: var(--border-color);
            border-right-color: var(--primary-color);
            box-shadow: none;
        }
        /* كلاس مخصص لتصغير خط العنوان للمرحلة الإعدادية */
        .dynamic-title-frame.is-secondary {
            font-size: 1.1rem;
        }

        .app-footer { 
            text-align: center; 
            padding: 10px; 
            font-size: 0.85rem; 
            color: #555; 
            border-top: 1px solid var(--border-color); 
            background-color: #f9fafb; 
            flex-shrink: 0; 
            z-index: 50; 
            transition: transform 0.3s ease-out, opacity 0.3s ease-out; 
        }
        body.dark-mode .app-footer {
            color: var(--text-color);
            background-color: #1a1a1a;
        }
        
        #section-list {
            /* لجعل القائمة تتمدد وتأخذ المساحة المتاحة */
            flex-grow: 1;
            /* لتفعيل التمرير العمودي داخل القائمة فقط */
            overflow-y: auto;
            
            /* تصميم جديد ومميز للحاوية */
            width: 100%;
            max-width: 500px;
            padding: 10px; 
            margin: 15px auto;
            background-color: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 12px; 
            box-shadow: inset 0 0 8px rgba(0,0,0,0.07);
        }
        .section-list-item {
          display: flex;
          justify-content: space-between;
          align-items: center;
          border-radius: 8px;
          padding: 12px;
          background-color: var(--light-color);
          transition: background 0.2s ease;
          border: 1px solid var(--border-color);
          margin-bottom: 10px;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .section-list-item:last-child { margin-bottom: 0; }
        .section-list-item:hover { 
            background-color: color-mix(in srgb, var(--light-color) 90%, #88888833);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        } 
        .section-list-item > span:first-child { cursor: pointer; flex-grow: 1; color: var(--primary-color); font-weight: 500;} 
        .section-name { font-size: 1rem; } 
        .delete-section-icon {
            color: var(--danger-color); font-weight: bold; cursor: pointer;
            font-size: 1.4rem; padding: 0 6px; line-height: 1; border-radius: 4px; 
        }
        .delete-section-icon:hover { background-color: var(--danger-color); color: white; }


        #page-grades-table .grades-table-header-area { 
            flex-shrink: 0;
            text-align: center;
            margin-bottom: 5px; 
            transition: opacity 0.2s ease-out, height 0.3s ease-out, margin 0.3s ease-out, padding 0.3s ease-out; 
            height: auto;
            padding-bottom: 5px;
        }
        #page-grades-table .actions-bar { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
            gap: 8px;
            flex-shrink: 0;
            margin-bottom: 8px;
            padding: 8px; 
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease-out; 
            position: sticky; 
            top: 0; 
            background-color: var(--container-bg); 
            z-index: 50; 
        }

        .table-responsive { 
            overflow: auto; 
            -webkit-overflow-scrolling: touch; 
            border: 1px solid var(--border-color); border-radius: 8px; 
            background-color: var(--container-bg); 
            box-shadow: 0 2px 6px rgba(0,0,0,0.08); 
            flex-grow: 1; 
            width: 100%;
            position: relative; 
        }
        table#studentsTable { 
            border-collapse: separate; 
            width: 100%; 
            border-spacing: 0; 
        }

        thead.screen-header th, #studentsTable tbody td {
            border: 1px solid var(--border-color); 
            padding: 8px 10px; 
            text-align: center; 
            font-size: 0.9rem; 
            word-break: normal; 
            background-color: var(--container-bg); 
            color: var(--text-color); 
            vertical-align: middle; 
            transition: background-color 0.3s;
        }
        #studentsTable tbody td {
             height: 32px; 
        }
        #studentsTable tbody tr:nth-child(even) td {
            background-color: var(--table-row-even-bg);
        }
        #studentsTable tbody tr:hover td {
             background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        /* كود تفعيل وضع التركيز على الجدول */
        #studentsTable.row-focused tbody .student-row {
            opacity: 0.2; /* زيادة التعتيم للصفوف الأخرى لتصبح خافتة جداً */
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        /* كود تمييز الصف الذي تم النقر عليه */
        /* كود تمييز الصف الذي تم النقر عليه */
        /* كود تمييز الصف الذي تم النقر عليه */
        #studentsTable.row-focused tbody .student-row.is-focused {
            opacity: 1; /* فقط إعادة الوضوح الكامل للصف المحدد */
        }
        thead.screen-header th { 
            background-color: var(--table-header-bg); 
            font-weight: 600; 
            color: var(--dark-color); 
            white-space: nowrap; 
            padding: 10px 12px; 
        }
        
        thead.screen-header tr:first-child th { 
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 30; 
            background-color: var(--table-sticky-header-bg);
        }
        thead.screen-header tr:nth-child(2) th { 
            position: -webkit-sticky;
            position: sticky;
            top: 0; /* Dynamically set by JS */
            z-index: 20; 
            background-color: var(--table-sticky-header-bg);
        }

        .th-sticky, .td-sticky { 
            position: -webkit-sticky; position: sticky;
            right: 0; 
            background-color: var(--table-sticky-bg) !important; 
        }
        #studentsTable tbody tr:nth-child(even) .td-sticky {
            background-color: var(--table-row-even-bg) !important;
        }
        #studentsTable tbody tr:hover .td-sticky {
             background-color: color-mix(in srgb, var(--primary-color) 10%, transparent) !important;
        }

        .th-sticky { 
            z-index: 40 !important; 
            background-color: var(--table-sticky-header-bg) !important;
        }
        thead.screen-header tr:first-child .th-sticky { top: 0; }
        thead.screen-header tr:nth-child(2) .th-sticky { top: 0; /* Dynamically set by JS */ }


        thead.screen-header .group-header {
            font-weight: bold;
        }
        thead.screen-header th.th-allow-wrap {
            white-space: normal; 
            min-width: 70px; 
        }
        .screen-header .action-col { min-width: 65px; } 

        .screen-header .th-student-name { 
            min-width: 120px; 
            vertical-align: top; 
            padding-top: 6px; 
        }
        .screen-header .student-name-header-text-container { 
            min-width: 120px;
            font-weight: 600; 
        }
         #studentsTable tbody .col-name { min-width: 120px; } 

        .screen-header .th-default-width, #studentsTable tbody .td-default-width { 
            min-width: 65px; 
        }
        .screen-header .th-no-col, #studentsTable tbody .col-no-cell { display: none !important; } 

        #studentsTable input.student-name {
            font-weight: 500; 
        }
        #studentsTable input.student-name[readonly] {
            background-color: var(--input-readonly-bg);
            color: var(--secondary-color); 
            border-style: dashed; 
            cursor: default;
        }


        .name-col-resize-controls {
            display: inline-flex; 
            align-items: center; 
            vertical-align: middle;
            margin-right: 0px; 
        }
        .name-col-resize-controls button {
            font-size: 0.85rem; 
            padding: 4px 6px; 
            margin: 0 2px; 
            background-color: #e0e6ec; color: #333; border: 1px solid #b0b9c6; 
            border-radius: 4px; cursor: pointer; 
            line-height: 1; 
        }
        body.dark-mode .name-col-resize-controls button {
            background-color: #454d55; color: #ccc; border: 1px solid #666;
        }


        input[type="text"], input[type="number"] {
            width: 100%; 
            padding: 0 4px; 
            box-sizing: border-box; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            text-align: center; 
            font-size: 0.9rem; 
            background-color: var(--container-bg); 
            color: var(--text-color); 
            height: 30px; 
            line-height: 30px; 
            vertical-align: middle; 
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input[type="text"]:focus, input[type="number"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent); 
            outline: 2px solid transparent;
        }
        input[readonly] { 
            background-color: var(--input-readonly-bg); 
            cursor: not-allowed; 
            font-weight: bold; 
            color: var(--text-color); 
        }
        .canvas-span {
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 100% !important;
            height: 100% !important;
            min-height: 30px !important; 
            font-size: 0.9rem !important; 
            font-family: 'Tajawal', sans-serif !important;
            text-align: center !important;
            box-sizing: border-box !important;
            color: var(--text-color); 
        }
        .grade-fail, span.grade-fail { background-color: var(--grade-fail-bg) !important; color: var(--grade-fail-text) !important; font-weight: bold; } 
        .grade-excellent, span.grade-excellent { background-color: var(--grade-excellent-bg) !important; color: var(--grade-excellent-text) !important; font-weight: bold; } 
        .s1-final-bg-color, span.s1-final-bg-color { background-color: var(--s1-final-bg-base) !important; }
        .s2-final-bg-color, span.s2-final-bg-color { background-color: var(--s2-final-bg-base) !important; }
        .annual-effort-bg-color, span.annual-effort-bg-color { background-color: var(--annual-effort-bg-base) !important; }
        .overall-final-bg-color, span.overall-final-bg-color { background-color: var(--overall-final-bg-base) !important; }
        
        #page-grades-table .actions-bar .back-btn-table-container,
        #page-grades-table .actions-bar .dropdown-table-tools-container {
        }
        #page-grades-table .actions-bar .btn {
            flex-shrink: 0; 
            padding: 6px 10px;
            font-size: 0.85rem;
        }
        #actionsDropdownToggle {
            padding: 6px 10px; 
        }

        .dropdown { position: relative; display: inline-block; }
        
        .dropdown-content {
  display: none;
  position: absolute;
  z-index: 1000;
  min-width: 220px;
  margin-top: 6px;
  background-color: var(--container-bg);
  padding: 10px;
  border-radius: 10px;
  /* ظل أكثر عمقاً وأناقة */
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 1px 8px rgba(0, 0, 0, 0.06);
  border: 1px solid var(--border-color);
  /* جعل القائمة أطول قليلاً */
  max-height: 360px;
  overflow-y: auto;
}
        .dropdown-align-left .dropdown-content { left: 0; right: auto; }
        .dropdown-align-right .dropdown-content {
             right: 0;
             left: auto;
        }
        
        .dropdown-content.active { display: block; }

        /* === التصميم الجديد والمحسّن لقائمة أدوات الجدول === */
        .modern-dropdown {
    padding: 8px !important;
    /* جعل القائمة أضيق قليلاً */
    min-width: 230px !important; 
    /* لون جديد مختلف وأنيق (لون عاجي/بيج فاتح) */
    background-color: #f1f7fe;
    opacity: 0;
    /* تعديل التحويل لتحقيق انبثاق أجمل */
    transform: translateY(-5px) scale(0.95);
    transform-origin: top right;
    pointer-events: none;
    /* حركة انبثاق ناعمة واحترافية */
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}
        /* 3. عند إضافة كلاس active، تظهر القائمة بحركة جميلة */
        .modern-dropdown.active {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
        }
        /* تعديل الوضع الليلي للون الخلفية الجديد */
        body.dark-mode .modern-dropdown {
    /* لون داكن متناسق مع اللون الجديد */
    background-color: #2c2c2e; 
}

        .dropdown-item-new {
    display: flex;
    align-items: center;
    /* نصوص أنيقة مع مسافات مريحة */
    padding: 12px 20px;
    border-radius: 6px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    font-size: 0.9rem;
    font-weight: 500;
    /* إضافة تباعد بسيط بين الحروف للأناقة */
    letter-spacing: 0.3px;
    color: var(--text-color);
}
/* كود إجباري لتغيير شكل الزر المعطل */
        .dropdown-item[disabled] {
            background-color: #e9ecef !important;
            color: #6c757d !important;
            cursor: not-allowed !important;
            opacity: 0.7 !important;
        }
        .btn-focus-mode {
            color: var(--primary-color) !important;
            font-weight: 700 !important;
        }
        .checkmark-icon {
            display: inline-block;
            width: 24px;
            text-align: center;
            margin-left: 12px;
            font-weight: bold;
            color: transparent;
            transition: color 0.2s ease;
        }
        .dropdown-item-new.active .checkmark-icon {
            color: var(--success-color); /* لون علامة الصح */
        }
        .dropdown-item-new.active .checkmark-icon::before {
            content: '✓'; /* شكل علامة الصح */
        }

        .dropdown-item-new:hover {
            background-color: color-mix(in srgb, var(--container-bg) 90%, #88888833);
        }
        .dropdown-item-new span:first-child { /* The Icon */
            margin-left: 12px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
            color: var(--secondary-color);
        }
        .dropdown-item-new.dropdown-item-danger,
        .dropdown-item-new.dropdown-item-danger span {
            color: var(--danger-color);
            font-weight: 700;
        }
        .dropdown-item-new.dropdown-item-danger:hover {
            background-color: color-mix(in srgb, var(--danger-color) 15%, transparent);
            color: var(--danger-color) !important;
        }
        .dropdown-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 8px 5px;
        }
        
        .dropdown-arrow {
            margin-right: 6px; 
            font-size: 0.85em; 
            display: inline-block;
            vertical-align: middle;
            transition: transform 0.2s ease-in-out;
        }
        .dropdown-arrow.open { 
            transform: rotate(180deg);
        }
        .add-section-container {
            position: relative;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            width: 100%; 
            max-width: 380px; 
            margin: 5px auto; 
        }
        #add-section-main-btn {
            width: 100%; 
        }

        #add-section-options-dropdown {
            position: fixed !important;
            top: 50% !important;
            left: 50% !important;
            transform: translate(-50%, -50%) !important;
            width: 220px;
            z-index: 2000;
            display: none;
        }
        #add-section-options-dropdown .dropdown-content { 
            width: 100%; 
            min-width: unset; 
            position: static;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            max-height: 70vh; 
            overflow-y: auto;
            background-color: var(--container-bg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 12px;
            scrollbar-width: thin;
            scrollbar-color: var(--secondary-color) transparent;
        }
        /* خدعة CSS لتوسيط القائمة القصيرة فقط */
        #add-section-options-dropdown .dropdown-content::before,
        #add-section-options-dropdown .dropdown-content::after {
            content: '';
            margin: auto;
        }
        #add-section-options-dropdown .dropdown-content::-webkit-scrollbar {
            width: 6px;
        }
        #add-section-options-dropdown .dropdown-content::-webkit-scrollbar-thumb {
            background-color: var(--secondary-color);
            border-radius: 3px;
        }
        #add-section-options-dropdown .dropdown-item {
            font-size: 1rem;
            padding: 10px;
            width: 100%;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }
        #add-section-options-dropdown .dropdown-item:last-child {
            border-bottom: none;
        }
         .language-options-header, .letter-options-header {
            padding: 10px 15px;
            font-weight: bold;
            color: var(--primary-color);
            background-color: var(--table-header-bg);
            width: 100%;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .modal {
            display: none; position: fixed; z-index: 1001; left: 0; top: 0;
            width: 100%; height: 100%; overflow: hidden; 
            background-color: rgba(0,0,0,0.7); 
            padding-top: 0; 
            align-items: center; justify-content: center; 
        }
        body.dark-mode .modal {
             background-color: rgba(0,0,0,0.85); 
        }
        .modal.active { display: flex; }
       #customConfirmModal {
            z-index: 1002;
        }

        .modal-content { 
            background-color: var(--container-bg); margin: auto; padding: 25px; 
            border: 1px solid var(--border-color); width: 90%; max-width: 500px; border-radius: 12px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.35); 
            max-height: 90vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden; 
        }
        .modal-content-body { 
            overflow-y: auto;
            flex-grow: 1;
        }
        .modal-content textarea { 
            width: 100%; 
            min-height: 130px; 
            margin-bottom: 12px; 
            padding: 10px; 
            font-size: 0.9rem; 
            border: 1px solid var(--border-color); 
            border-radius: 5px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
        }
        .close-modal-btn { color: #aaa; float: left; font-size: 28px; font-weight: bold; } 
        .close-modal-btn:hover, .close-modal-btn:focus { color: var(--dark-color); text-decoration: none; cursor: pointer; }

        /* Editing Mode Styles */
        body.table-editing-mode .academic-header,
        body.table-editing-mode .app-footer {
            transform: translateY(150%); 
            opacity: 0;
        }
        body.table-editing-mode #developerInfoHamburger,
        body.table-editing-mode #page-grades-table .grades-table-header-area { 
            opacity: 0;
            pointer-events: none;
            height: 0; 
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        
        body.table-editing-mode .grades-table-content-wrapper {
            position: fixed !important;
            z-index: 2000 !important;
            display: flex !important;
            flex-direction: column !important;
            top: 0 !important;
            bottom: 0 !important;
            left: 0 !important;
            right: 0 !important;
            width: auto !important;
            box-sizing: border-box !important;
            background-color: var(--container-bg) !important;
            padding: 10px !important;
            border-radius: 0 !important;
            transform: none !important;
            border: 2px solid var(--primary-color) !important;
            box-shadow: none !important;
            outline: none !important;
            margin: 0 !important; /* Ensure no margin in editing mode */
        }
        
        body.table-editing-mode #page-grades-table .actions-bar {
            opacity: 1; 
            pointer-events: auto;
            position: sticky; 
            top: 0; 
            background-color: var(--container-bg); 
            z-index: 2010; 
            padding: 5px 8px; 
            border-bottom: 1px solid var(--border-color);
            transform: translateY(0); 
            flex-shrink: 0; 
            width: 100%; 
            box-sizing: border-box;
            border-radius: 0;
        }
        body.table-editing-mode .table-responsive {
             flex-grow: 1; 
             height: auto; 
             max-height: none;
             border-radius: 0; 
             border-left: none;
             border-right: none;
             border-bottom: none;
        }

        /* >>> الصق الكود الجديد هنا <<< */
        /* === بداية كود تنسيق جدول الشفوي لمطابقة الجدول الرئيسي === */

        /* تطبيق لون الخلفية وخامة الخط على جدول الشفوي */
        #oralTestTable th, #oralTestTable td {
            color: var(--text-color);
            background-color: var(--container-bg);
        }

        /* تطبيق تخطيط السطور الملونة (مخطط) */
        #oralTestTable tbody tr:nth-child(even) td {
            background-color: var(--table-row-even-bg);
        }
        
        /* تطبيق تأثير المرور (hover) */
        #oralTestTable tbody tr:hover td {
             background-color: color-mix(in srgb, var(--primary-color) 10%, transparent);
        }
        #oralTestTable tbody tr:hover .td-sticky {
             background-color: color-mix(in srgb, var(--primary-color) 10%, transparent) !important;
        }

        /* إعادة الفاصل السفلي عند التحرير */
        body.table-editing-mode .grades-table-content-wrapper::after {
            content: '';
            display: block;
            height: 12px; /* يمكنك تعديل هذا الارتفاع إذا أردت */
            background-color: var(--container-bg);
            flex-shrink: 0;
        }

        /* === نهاية كود تنسيق جدول الشفوي === */
             height: auto; 
             max-height: none;
             border-radius: 0; 
             border-left: none;
             border-right: none;
             border-bottom: none;
        }

        /* >>> الصق الكود الجديد هنا <<< */
        ..th-vertical {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            transform: rotate(180deg);
            white-space: nowrap;
            padding: 10px 4px !important;
            font-size: 0.85rem !important;
        }

        /* >>> الصق الكود الجديد هنا <<< */
        #oralTestTable tbody td {
            padding-top: 8px;
            padding-bottom: 8px;
        }
        #oralTestTable tbody td {
            padding-top: 8px;
            padding-bottom: 8px;
            /* السطرين التاليين لضبط المحاذاة الأفقية */
            padding-left: 18px;
            padding-right: 18px;
        }

        /* >>> الكود الجديد هنا <<< */
        /* تصغير عرض حقول الدرجات في جدول الشفوي */
        /* كود إجباري لتوسيط حقول الدرجات مع إزاحة بسيطة */
        .grades-table#oralTestTable .grade-input {
            width: 60px;
            display: block;
            margin: 0 auto;
            margin-right: -2px; /* <<< إزاحة بسيطة لليسار للمحاذاة الدقيقة */
        }

        thead.print-header { display: none; } 
        thead.print-header th {
            font-size: 6pt !important; padding: 2px 1px !important;
            border: 1px solid black !important; background-color: #e9ecef !important; 
            font-weight: bold; text-align: center; vertical-align: middle; white-space: normal; 
        }
        thead.print-header .merged-main-header { font-size: 6.5pt !important; background-color: #dcdcdc !important; }
        thead.print-header .merged-sub-header { font-size: 6.2pt !important; background-color: #e6e6e6 !important; }

        #imagePreviewModal, #analyticsModal { 
            display: none;
            position: fixed;
            z-index: 1050;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            align-items: center; 
            justify-content: center; 
        }
        #imagePreviewModal.active, #analyticsModal.active { display: flex; }
        
        .image-preview-container, .analytics-container { 
            position: relative;
            width: 90%;
            margin: 30px auto; 
            background-color: var(--container-bg);
            border-radius: 10px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            overflow: hidden; 
            display: flex; 
            flex-direction: column;
            max-height: 90vh; 
        }
        .analytics-container { 
            max-width: 750px; 
        }


        .image-preview-header, .analytics-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px; 
            background-color: var(--light-color); 
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; 
        }
        
        .image-preview-title, .analytics-title { 
            font-weight: bold;
            font-size: 1.2rem; 
            color: var(--primary-color); 
            white-space: nowrap; 
            overflow: hidden;
            text-overflow: ellipsis; 
            flex-grow: 1; 
            margin-left: 10px; 
        }
        
        .image-preview-controls, .analytics-controls { 
            display: flex;
            gap: 10px;
            flex-shrink: 0; 
        }
        
        .image-preview-content, .analytics-content-wrapper { 
            padding: 20px; 
            text-align: center;
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        .image-preview-content img {
            max-width: 100%;
            border: 1px solid var(--border-color);
            display: block; 
            margin: auto; 
            border-radius: 5px; 
        }
        
        .image-preview-footer, .analytics-footer { 
            padding: 12px 18px; 
            text-align: center;
            border-top: 1px solid var(--border-color);
            background-color: var(--light-color); 
            flex-shrink: 0; 
        }

        .analytics-section {
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            background-color: var(--bg-color); 
            margin-bottom: 15px; 
        }
        .analytics-section:last-child {
            margin-bottom: 0;
        }
        .analytics-section h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
            text-align: right;
        }
        
        #gradeDistributionChartContainer {
            width: 100%;
            max-width: 500px; 
            margin: 0 auto;
            height: 250px; 
        }
        #individualStudentChartContainer { 
            width: 100%;
            max-width: 650px; 
            margin: 15px auto 0 auto;
            height: 300px; 
        }
        .form-select-container { 
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .form-select-container label {
            font-weight: 500;
            color: var(--text-color);
        }
        #selectStudentForChart {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg);
            color: var(--text-color);
            min-width: 200px;
            max-width: 300px;
        }


        body.dark-mode #gradeDistributionChart, body.dark-mode #individualStudentGradeChart { 
            color: var(--text-color);
        }
        body.dark-mode .chartjs-legend li span {
             color: var(--text-color) !important;
        }
         body.dark-mode .chartjs-plugins-title {
            color: var(--text-color) !important;
        }


        #developerInfoHamburger {
            position: absolute;
            top: 15px; 
            left: 20px; 
            width: 35px;
            height: 30px;
            display: none; 
            flex-direction: column;
            justify-content: space-around;
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 0;
            z-index: 1100; 
            transition: opacity 0.3s ease-out; 
        }
        #developerInfoHamburger span {
            display: block;
            width: 100%;
            height: 3px;
            background-color: var(--header-text-color); 
            border-radius: 3px;
            transition: all 0.3s ease-in-out;
        }
        #developerInfoHamburger.active span:nth-child(1) {
            transform: translateY(10px) rotate(45deg);
        }
        #developerInfoHamburger.active span:nth-child(2) {
            opacity: 0;
        }
        #developerInfoHamburger.active span:nth-child(3) {
            transform: translateY(-10px) rotate(-45deg);
        }

        #developerInfoModal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6); 
            z-index: 1050; 
            align-items: center;
            justify-content: center;
            overflow: hidden; 
        }
         #developerInfoModal.active {
            display: flex; 
        }

        .developer-info-container { 
            background-color: var(--container-bg);
            padding: 0; 
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
            width: 90%;
            max-width: 400px; 
            text-align: right;
            position: relative; 
            display: flex;
            flex-direction: column;
            max-height: 90vh; 
            overflow: hidden; 
        }
        .developer-info-header { 
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px; 
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        .developer-info-title {
            color: var(--primary-color);
            font-size: 1.3rem;
            font-weight: bold;
        }
        .developer-info-content { 
             padding: 20px;
             overflow-y: auto; 
             flex-grow: 1;
        }
        .developer-info-content p { margin-bottom: 12px; font-size: 1.05rem; color: var(--text-color);}
        .developer-info-content strong { color: var(--primary-color); }
        .developer-info-content a { color: var(--elementary-color); text-decoration: none; font-weight: bold;}
        .developer-info-content a:hover { text-decoration: underline; color: var(--elementary-hover);}
        
        .close-developer-info-modal-btn { 
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-color); 
            background: none;
            border: none;
            cursor: pointer;
            padding: 0 5px; 
        }
        body.dark-mode .close-developer-info-modal-btn {
            color: var(--text-color);
        }

        .dark-mode-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 20px;
            padding-top: 15px; 
            border-top: 1px solid var(--border-color);
        }
        .dark-mode-toggle-container label {
            font-size: 1rem;
            color: var(--text-color);
            margin-left: 10px; 
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px; 
            height: 26px; 
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 26px; 
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px; 
            width: 20px;  
            left: 3px;    
            bottom: 3px;  
            background-color: white;
            transition: .4s;
            border-radius: 50%; 
        }
        input:checked + .slider {
            background-color: var(--primary-color);
        }
        input:checked + .slider:before {
            transform: translateX(24px); 
        }
        body.dark-mode .slider {
            background-color: #555;
        }
         body.dark-mode input:checked + .slider {
            background-color: var(--primary-color); 
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; transform: translateX(30px); }
        }
        .row-deleting {
            animation: fadeOut 0.4s ease-out forwards;
        }
        
        #recycle-bin-list {
            margin-top: 15px;
            max-height: 40vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .recycle-bin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background-color: var(--bg-color);
            margin-bottom: 8px;
        }
        .recycle-bin-item:last-child { margin-bottom: 0; }
        .recycle-bin-item-name { font-weight: 500; color: var(--text-color); }
        .recycle-bin-item-actions { display: flex; gap: 8px; }
        .recycle-bin-item-actions button {
            background: transparent; border: none; cursor: pointer; font-size: 1.5rem;
            padding: 2px 8px; line-height: 1; border-radius: 4px; transition: background-color 0.2s;
        }
        .btn-restore { color: var(--success-color); }
        .btn-restore:hover { background-color: var(--success-color); color: white; }
        .btn-delete-final { color: var(--danger-color); }
        .btn-delete-final:hover { background-color: var(--danger-color); color: white; }

        /* >>> الصق الكود الجديد هنا <<< */
        .btn-clear-oral-row {
            background: transparent;
            border: none;
            color: var(--danger-color);
            font-size: 1.6rem;
            cursor: pointer;
            line-height: 1;
        }
        .btn-clear-oral-row:hover {
            opacity: 0.7;
        }

        /* >>> الصق الكود الجديد هنا <<< */
        
        
        #bin-select-all-container label span {
            font-weight: bold;
            color: var(--primary-color);
        }
        #bin-select-all-container input[type="checkbox"] {
            width: 18px;
            height: 18px;
        }
        .recycle-bin-item label {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            cursor: pointer;
        }
        #openRecycleBinBtn {
            font-size: 1.5rem; padding: 0 12px; background: transparent; border: none;
            color: var(--secondary-color); position: absolute; top: 20px; left: 20px;
        }
         #openRecycleBinBtn:hover { color: var(--primary-color); }

        .success-indicator {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.5); z-index: 9999;
            align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.3s ease-in-out;
        }
        .success-indicator.visible { display: flex; opacity: 1; }
        .success-indicator-circle {
            width: 80px; height: 80px; background-color: rgba(40, 40, 40, 0.85);
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        .success-indicator-checkmark { font-size: 40px; color: var(--success-color); }
        

        @media (max-width: 768px) {
            .header-title { font-size: 1.6rem; }
            .main-selection-title { font-size: 1.5rem; }
            h1.page-main-title { font-size: 1.5rem; } 
            h2 { font-size: 1.3rem; }
            h3 { font-size: 1.05rem; }
            .btn-stage, .btn-grade-option { padding: 18px !important; font-size: 1.1rem !important; }
            .modal-content { padding: 20px; } 
            .container { padding: 15px; }
            #developerInfoHamburger { top: 12px; left: 15px; width: 32px; height: 28px;}
            #developerInfoHamburger span { height: 2.5px; }
             #developerInfoHamburger.active span:nth-child(1) { transform: translateY(8px) rotate(45deg); }
             #developerInfoHamburger.active span:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }
             #gradeDistributionChartContainer { height: 220px; }
             #individualStudentChartContainer { height: 250px; }
             .analytics-title { font-size: 1.1rem; }
        }
        @media (max-width: 480px) {
            .header-title { font-size: 1.4rem; }
            .main-selection-title { font-size: 1.3rem; }
            h1.page-main-title { font-size: 1.3rem; } 
            h2 { font-size: 1.15rem; }
            h3 { font-size: 1rem; }
            .btn { padding: 8px 12px; font-size: 0.85rem; } 
             #page-grades-table .actions-bar .btn { 
                padding: 8px 10px; 
                font-size: 0.85rem;
            }
            .btn-stage, .btn-grade-option { padding: 15px !important; font-size: 1rem !important; }

            input[type="text"], input[type="number"], .canvas-span, thead.screen-header th, #studentsTable tbody td { font-size: 0.8rem; } 
             thead.screen-header th, #studentsTable tbody td { padding: 6px 8px; }
             input[type="text"], input[type="number"] { height: 28px; line-height: 28px;}
             .canvas-span { min-height: 28px;}
             #developerInfoHamburger { top: 10px; left: 10px; width: 30px; height: 25px;}
             .developer-info-container { padding: 0; }
             .developer-info-header { padding: 12px 15px;}
             .developer-info-content { padding: 15px;}
             .dark-mode-toggle-container label { font-size: 0.9rem;}
             .toggle-switch { width: 44px; height: 22px;}
             .slider:before { height: 16px; width: 16px;}
             input:checked + .slider:before { transform: translateX(22px); }
             #gradeDistributionChartContainer { height: 200px; }
             #individualStudentChartContainer { height: 220px; }
             .analytics-title { font-size: 1rem; }
             #openRecycleBinBtn { top: 15px; left: 15px; }
        }

        #generalStats {
            display: flex; /* تغيير إلى Flexbox */
            flex-wrap: wrap; /* السماح للبطاقات بالالتفاف لسطر جديد */
            justify-content: center; /* توسيط البطاقات أفقياً */
            gap: 15px;
            text-align: center;
        }
        .stat-card {
            background-color: var(--container-bg);
            padding: 15px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            /* التحكم في حجم البطاقة لتكون مرنة */
            flex: 1 1 150px;
            min-width: 140px;
        }
        .stat-card strong {
            display: block;
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1.2;
            transition: color 0.3s ease;
        }
        .stat-card span {
            font-size: 0.85rem;
            color: var(--secondary-color);
        }
        #stdDevInterpretation {
            font-size: 0.75rem;
            margin-top: 5px;
            font-weight: 500;
            min-height: 2.2em;
            line-height: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        body.dark-mode .stat-card {
             box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    
        .search-input {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background-color: var(--light-color);
            color: var(--text-color);
            font-size: 1rem;
            transition: 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            min-width: 250px;
        }
        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color) 25%, transparent);
            background-color: #fff;
        }
        body.dark-mode .search-input {
            background-color: #2c2c2c;
            color: #fff;
            border: 1px solid var(--border-color);
        }
        #gradesTableResponsiveContainer {
            overflow-y: auto;
            overflow-x: auto;
            scroll-behavior: smooth;
            scroll-snap-type: both proximity;
        }

        body.in-grades-page .academic-header,
        body.in-grades-page .app-footer {
            display: none !important;
        }

        .in-grades-page .grades-table-content-wrapper {
            border: 2px solid var(--primary-color);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin: 10px;
            overflow: hidden;
            padding: 0;
        }

        body.in-grades-page .actions-bar {
            position: static;
            border-bottom: 1px solid var(--border-color);
            border-top-left-radius: 10px;
            border-top-right-radius: 10px;
            margin-bottom: 0;
        }

        body.in-grades-page .table-responsive {
            border: none;
            box-shadow: none;
            border-radius: 0;
        }

        thead.screen-header th {
            background-color: var(--table-sticky-header-bg);
        }

        

        .special-analytics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }
        .stats-list {
            list-style: none;
            padding: 0;
            margin: 0;
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 8px;
            background-color: var(--container-bg);
        }
        .stats-list li {
            display: flex;
            justify-content: space-between;
            padding: 6px 5px;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .stats-list li:last-child {
            border-bottom: none;
        }
        .stats-list li .grade {
            font-weight: bold;
            margin-right: 10px;
        }
        .stats-list li .grade.grade-fail {
             color: var(--grade-fail-text) !important;
        }
        .stats-list li .grade.grade-excellent {
             color: var(--grade-excellent-text) !important;
        }
        .stats-list .no-students-msg {
            text-align: center;
            color: var(--secondary-color);
            padding: 20px 0;
            border-bottom: none;
        }
        
        #analyticsFilterContainer {
            padding: 10px 15px;
            background-color: var(--bg-color);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        #analyticsFilterContainer label {
            font-weight: 500;
        }
        #analyticsColumnSelector {
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            background-color: var(--container-bg);
            color: var(--text-color);
            min-width: 220px;
            font-weight: 500;
        }
        
        .analytics-section h3 {
            color: var(--dark-color);
            text-align: center;
            font-weight: 700;
            font-size: 1.15rem;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 5px;
        }
        body.dark-mode .analytics-section h3 {
            color: var(--text-color);
        }
        
        @media (max-width: 600px) {
            .special-analytics-grid {
                grid-template-columns: 1fr;
            }
            
        }
        /* تصميم سلة محذوفات الطلاب */
        #student-recycle-bin-list {
            margin-top: 15px;
            max-height: 45vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
        }
        .student-recycle-bin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-radius: 6px;
            background-color: var(--bg-color);
            margin-bottom: 8px;
        }
        .student-recycle-bin-item:last-child { margin-bottom: 0; }
        .student-recycle-bin-item-name { 
            font-weight: 500; 
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
            line-height: 1.3;
        }
        .student-recycle-bin-item-name small {
            font-size: 0.75rem;
            color: var(--secondary-color);
        }
        .student-recycle-bin-item-actions { display: flex; gap: 8px; }
        /* تنسيق العناصر الجديدة في سلة محذوفات الطلاب */
        .student-recycle-bin-item label {
            display: flex;
            align-items: center;
            justify-content: space-between; /* هذا يضع الاسم يميناً والمربع يساراً */
            cursor: pointer;
            width: 100%;
        }
        .student-recycle-bin-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            /* لم نعد بحاجة لهامش هنا */
        }
        ..modal-actions-footer {
            padding-top: 15px;
            margin-top: 15px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        /* >>> الصق الكود الجديد هنا <<< */
        /* تنسيق الملاحظة المتحركة */
        .marquee-container {
            width: 100%;
            overflow: hidden;
            background-color: var(--bg-color);
            border-radius: 4px;
        }
        .marquee-text {
            display: inline-block;
            color: var(--secondary-color);
            font-size: 0.8rem;
            white-space: nowrap;
            padding: 4px 0;
            animation: marquee 15s linear infinite;
        }
        @keyframes marquee {
            0%   { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }

        /* === بداية كود قوة كلمة المرور === */
        .modal-content.password-weak {
            border: 2px solid var(--danger-color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--danger-color) 30%, transparent);
        }
        .modal-content.password-medium {
            border: 2px solid var(--warning-color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--warning-color) 30%, transparent);
        }
        .modal-content.password-strong {
            border: 2px solid var(--success-color);
            box-shadow: 0 0 15px color-mix(in srgb, var(--success-color) 30%, transparent);
        }
        #loginPasswordInput.input-error {
            border: 2px solid var(--danger-color) !important;
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        /* === نهاية كود قوة كلمة المرور === */

    </style>
    </style>
</head>
<body>
    <div class="academic-header">
        <button id="developerInfoHamburger">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <h1 class="header-title">إدارة الدرجات الأكاديمي</h1>
    </div>

    <div id="developerInfoModal">
        <div class="developer-info-container">
            <div class="developer-info-header">
                 <h2 class="developer-info-title">معلومات المطور</h2>
                 <button id="closeDeveloperInfoModalBtn" class="close-developer-info-modal-btn">&times;</button>
            </div>
            <div class="developer-info-content">
                <p><strong>المطور:</strong> أحمد فلاح ™</p>
                <p><strong>الوظيفة:</strong> EFL TUTOR</p>
                <p><strong>الهواية:</strong> Programming</p>
                <p><strong>للتواصل:</strong> <a href="https://t.me/ahmedyakuz" target="_blank" rel="noopener noreferrer">𝗙𝗼𝗹𝗹𝗼𝘄 𝗺𝗲 →</a></p>
                
                <p id="setPasswordLink" style="color: var(--danger-color); cursor: pointer; font-weight: bold;">تعيين كلمة المرور</p>
                <div class="dark-mode-toggle-container">
                    <label for="darkModeToggle">تفعيل الوضع الليلي</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="darkModeToggle">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
    </div>


    <div id="page-main-selection" class="page container active">
        <h2 class="main-selection-title">اختر المرحلة الدراسية</h2>
        <button id="select-stage-elementary" class="btn btn-stage btn-elementary">المرحلة الابتدائية</button>
        <button id="select-stage-intermediate" class="btn btn-stage btn-intermediate">المرحلة المتوسطة</button>
        <button id="select-stage-secondary" class="btn btn-stage btn-secondary-stage">المرحلة الإعدادية</button>
    </div>

    <div id="page-elementary-grades" class="page container">
        <h2>اختر الصف - المرحلة الابتدائية</h2>
        <button class="btn btn-grade-option btn-elementary" data-grade-key="grade5" data-grade-text="الصف الخامس الابتدائي">الصف الخامس</button>
        <button class="btn btn-grade-option btn-elementary" data-grade-key="grade6" data-grade-text="الصف السادس الابتدائي">الصف السادس</button>
        <button class="back-btn btn btn-secondary">رجوع</button>
    </div>

    <div id="page-intermediate-grades" class="page container">
        <h2>اختر الصف - المرحلة المتوسطة</h2>
        <button class="btn btn-grade-option btn-intermediate" data-grade-key="intermediate1" data-grade-text="الصف الأول المتوسط">الصف الأول المتوسط</button>
        <button class="btn btn-grade-option btn-intermediate" data-grade-key="intermediate2" data-grade-text="الصف الثاني المتوسط">الصف الثاني المتوسط</button>
        <button class="btn btn-grade-option btn-intermediate" data-grade-key="intermediate3" data-grade-text="الصف الثالث المتوسط">الصف الثالث المتوسط</button>
        <button class="back-btn btn btn-secondary">رجوع</button>
    </div>

      <div id="page-secondary-branches" class="page container">
        <h2>اختر المسار - المرحلة الإعدادية</h2>
        <button id="select-secondary-scientific" class="btn btn-stage btn-secondary-stage">المسار العلمي</button>
        <button id="select-secondary-literary" class="btn btn-stage btn-secondary-stage">المسار الأدبي</button>
        <button class="back-btn btn btn-secondary">رجوع</button>
    </div>

    <div id="page-secondary-grades" class="page container">
        <h2>اختر الصف - المرحلة الإعدادية (<span id="current-branch-text">المسار</span>)</h2>
        <button class="btn btn-grade-option btn-secondary-stage secondary-grade-btn" data-grade-key-base="secondary_X_4" data-grade-text-base="الصف الرابع الإعدادي - المسار">الصف الرابع</button>
        <button class="btn btn-grade-option btn-secondary-stage secondary-grade-btn" data-grade-key-base="secondary_X_5" data-grade-text-base="الصف الخامس الإعدادي - المسار">الصف الخامس</button>
        <button class="btn btn-grade-option btn-secondary-stage secondary-grade-btn" data-grade-key-base="secondary_X_6" data-grade-text-base="الصف السادس الإعدادي - المسار">الصف السادس</button>
        <button class="back-btn btn btn-secondary">رجوع</button>
    </div>

    <div id="page-grade-options" class="page container" style="position: relative;">
        <button id="openRecycleBinBtn" title="سلة المهملات">🗑️</button>
        
        <h2 id="grade-options-title" class="dynamic-title-frame"></h2>

        <div class="actions-grid-new">
            <button id="go-to-main-class-btn" class="action-card-new btn-academic-blue">
                <span class="action-icon-new">📋</span>
                <span class="action-text-new">القائمة الرئيسية</span>
            </button>
            <button id="enter-sections-btn" class="action-card-new btn-academic-teal">
                <span class="action-icon-new">🚪</span>
                <span class="action-text-new">الدخول للشعب</span>
            </button>
            <button id="add-section-main-btn" class="action-card-new btn-academic-green">
                <span class="action-icon-new">✚</span>
                <span class="action-text-new">اضف شعبة</span>
            </button>
            <button class="back-btn action-card-new btn-academic-gray">
                <span class="action-icon-new">⏎</span>
                <span class="action-text-new">رجوع</span>
            </button>
        </div>
    </div>

    <div id="add-section-options-dropdown">
        <div class="dropdown-content">
            </div>
    </div>

    <div id="page-actual-section-management" class="page container">
        <h2>شعب <span id="current-grade-level-text-manage">الصف</span></h2>
        <div class="container-content" style="width:100%; max-width: 500px;">
            <h3 style="margin-top: 15px; margin-bottom: 10px; font-weight:bold; color: var(--primary-color); border-top: 1px solid var(--border-color); padding-top: 15px;">الشعب المتاحة</h3>
            <div id="section-list" style="width: 100%; margin: 0 auto 15px auto;">
                </div>
            <button class="back-btn btn btn-secondary" style="margin-top: 20px;">رجوع إلى خيارات الصف</button>
        </div>
    </div>


    <div id="page-grades-table" class="page">
        <div class="grades-table-content-wrapper">
            <div class="actions-bar">
                <div class="dropdown-table-tools-container dropdown dropdown-align-right">
                    <button id="actionsDropdownToggle" class="btn btn-primary">أدوات الجدول<span class="dropdown-arrow">▼</span></button>
                    <div id="actionsDropdownContent" class="dropdown-content modern-dropdown">
    <div class="dropdown-item-new" id="addStudentBtn"><span>+</span><span>إضافة طالب</span></div>
    <div class="dropdown-item-new" id="oralTestBtn"><span>📝</span><span>قائمة الشفوي EN</span></div>
    <div class="dropdown-item-new" id="import-txt-btn"><span>📁</span><span>استيراد أسماء TXT</span></div>
    <div class="dropdown-item-new" id="text-to-txt-btn"><span>✎</span><span>إدخال أسماء نصية</span></div>
    
    
    <div class="dropdown-item-new btn-focus-mode" id="toggleFocusModeBtn">
        <span class="checkmark-icon"></span>
        <span>وضع التركيز🗿</span>
    </div>
    
    <div class="dropdown-divider"></div>

    <div class="dropdown-item-new" id="sort-az-btn"><span>⇑</span><span>ترتيب أبجدي (أ-ي)</span></div>
    <div class="dropdown-item-new" id="sort-za-btn"><span>⇓</span><span>ترتيب أبجدي (ي-أ)</span></div>

    <div class="dropdown-divider"></div>

    <div class="dropdown-item-new" id="showAnalyticsBtn"><span>📊</span><span>التحليلات والتقارير</span></div>
    <div class="dropdown-item-new" id="import-json-btn"><span>⎘</span><span>استيراد البيانات</span></div>
    <div class="dropdown-item-new" id="export-json-btn"><span>⎗</span><span>تصدير البيانات</span></div>
    <div class="dropdown-item-new" id="previewImageBtn"><span>🎞️</span><span>معاينة كصورة</span></div>
    <div class="dropdown-item-new" id="printBtn"><span>⎙</span><span>تحميل PDF</span></div>

    <div class="dropdown-divider"></div>

    <div class="dropdown-item-new" id="openStudentRecycleBinBtn"><span>♻️</span><span>المحذوفات</span></div>
    <div class="dropdown-item-new dropdown-item-danger" id="deleteAllBtn"><span>⚠</span><span>حذف جميع الطلاب</span></div>
</div>
                </div>
                 <div class="back-btn-table-container">
                     <button id="backToGradeOptionsBtnTable" class="btn btn-secondary">رجوع</button>
                </div>
                <input type="search" id="searchInput" placeholder="ابحث عن طالب..." class="search-input">
                <a id="downloadImageLink" style="display:none;"></a>
                <input type="file" id="txt-file-input" accept=".txt" style="display: none;">
                <input type="file" id="json-file-input" accept=".json" style="display: none;">
            </div>
            <div class="table-responsive" id="gradesTableResponsiveContainer">
                <table id="studentsTable" class="grades-table">
                    <thead class="screen-header">
                        <tr>
                            <th class="th-no-col">م</th>
                            <th class="th-student-name th-sticky">
                                <div class="name-col-resize-controls">
                                    <button onclick="adjustStudentNameColumnWidth(true)">+</button>
                                    <button onclick="adjustStudentNameColumnWidth(false)">-</button>
                                </div>
                            </th>
                            <th colspan="4" class="group-header s1-group-header">الفصل الدراسي الأول</th>
                            <th rowspan="2" class="th-default-width th-allow-wrap sortable-header" data-sort-key="mid-year">اختبار منتصف العام<span class="sort-arrow">▼</span></th>
                            <th colspan="3" class="group-header">الفصل الدراسي الثاني</th>
                            <th rowspan="2" class="th-default-width th-allow-wrap sortable-header" data-sort-key="annual-effort">المجهود السنوي<span class="sort-arrow">▼</span></th>
                            <th rowspan="2" class="th-default-width th-allow-wrap sortable-header" data-sort-key="final-exam">اختبار نهاية العام<span class="sort-arrow">▼</span></th>
                            <th rowspan="2" class="th-default-width th-allow-wrap sortable-header" data-sort-key="overall-final">المجموع النهائي<span class="sort-arrow">▼</span></th>
                            <th rowspan="2" class="action-col">حذف</th>
                        </tr>
                        <tr>
                            <th class="th-no-col">م</th>
                            <th class="th-sticky student-name-header-text-container">
                               اسم الطالب
                            </th> 
                            <th class="th-default-width sortable-header" data-sort-key="s1m1">شهر 1<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width sortable-header" data-sort-key="s1m2">شهر 2<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width elementary-only-cell sortable-header" data-sort-key="s1m3">شهر 3<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width sortable-header" data-sort-key="s1-final">مجموع ف1<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width sortable-header" data-sort-key="s2m1">شهر 1<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width sortable-header" data-sort-key="s2m2">شهر 2<span class="sort-arrow">▼</span></th>
                            <th class="th-default-width sortable-header" data-sort-key="s2-final">مجموع ف2<span class="sort-arrow">▼</span></th>
                        </tr>
                    </thead>
                    <thead class="print-header"> <tr>
                            <th rowspan="2" style="width: 20px;" class="col-no">م</th>
                            <th rowspan="2" style="width: 120px;">اسم الطالب</th>
                            <th colspan="4" class="merged-main-header print-s1-group-header">الفصل الدراسي الأول</th>
                            <th rowspan="2" style="width: 40px;">اختبار منتصف العام</th>
                            <th colspan="3" class="merged-main-header">الفصل الدراسي الثاني</th>
                            <th rowspan="2" style="width: 40px;">المجهود السنوي</th>
                            <th rowspan="2" style="width: 40px;">اختبار نهاية العام</th>
                            <th rowspan="2" style="width: 40px;">المجموع النهائي</th>
                        </tr>
                        <tr>
                            <th class="merged-sub-header" style="width: 30px;">شهر 1</th>
                            <th class="merged-sub-header" style="width: 30px;">شهر 2</th>
                            <th class="merged-sub-header elementary-only-cell" style="width: 30px;">شهر 3</th>
                            <th class="merged-sub-header" style="width: 40px;">مجموع ف1</th>
                            <th class="merged-sub-header" style="width: 30px;">شهر 1</th>
                            <th class="merged-sub-header" style="width: 30px;">شهر 2</th>
                            <th class="merged-sub-header" style="width: 40px;">مجموع ف2</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
                 <div id="empty-table-message" style="display: none; text-align: center; padding: 40px 20px; color: var(--secondary-color);">
                    <h3 style="font-size: 1.2rem; font-weight: 500;">لا يوجد طلاب بعد</h3>
                    <p style="margin-top: 10px;">انقر على "أدوات الجدول" ثم "إضافة طالب" للبدء.</p>
                </div>
            </div>
        </div>
        
        <div class="print-section" style="display: none;">
             <div class="print-title">
                <div id="print-title-grade">الصف: </div>
                <div id="print-title-section">الشعبة: </div>
            </div>
            <table id="printTable"></table>
        </div>
    </div>

    <div id="textToTxtModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink:0;">
                 <h3 style="text-align:center; color: var(--dark-color); margin:0; flex-grow:1;">إدخال أسماء الطلاب</h3>
                 <span id="closeTextToTxtModal" class="close-modal-btn" style="float:none;">&times;</span>
            </div>
            <div class="modal-content-body">
                <p style="margin-bottom: 10px; text-align:center;">ضع كل طالب في سطر</p>
                <textarea id="textToTxtInput" placeholder="أدخل أسماء الطلاب هنا، كل اسم في سطر منفصل"></textarea>
            </div>
            <div style="text-align: center; padding-top:15px; flex-shrink:0;">
                <button id="convertToTxtBtn" class="btn btn-primary">تحويل وتنزيل TXT</button>
            </div>
        </div>
    </div>

    <div id="customConfirmModal" class="modal">
        <div class="modal-content">
             <h3 id="customConfirmModalTitle" style="text-align:center; margin-bottom: 15px; color: var(--dark-color); flex-shrink:0;">تأكيد</h3>
            <div class="modal-content-body">
                <p id="customConfirmModalMessage" style="margin-bottom: 20px; text-align:center;"></p>
            </div>
            <div style="text-align: center; padding-top:15px; flex-shrink:0;">
                <button id="customConfirmModalOk" class="btn btn-danger" style="margin-left: 10px;">نعم</button> <button id="customConfirmModalCancel" class="btn btn-secondary">لا</button>
            </div>
        </div>
    </div>

    <div id="imagePreviewModal" class="modal">
        <div class="image-preview-container">
            <div class="image-preview-header">
                <div class="image-preview-title">معاينة الجدول كصورة</div>
                <button id="closeImagePreview" class="btn btn-light close-modal-btn" style="padding: 5px 10px; margin: 0; font-size: 1.5rem; background: transparent; border: none; color: var(--text-color);">&times;</button>
            </div>
            <div class="image-preview-content">
                <img id="previewImage" src="" alt="معاينة الجدول">
            </div>
            <div class="image-preview-footer">
                <button id="saveImageBtn" class="btn btn-success">حفظ الصورة</button>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="modal">
        <div class="analytics-container">
            <div class="analytics-header">
                <div class="analytics-title">التحليلات والتقارير</div>
                 <button id="closeAnalyticsModal" class="btn btn-light close-modal-btn" style="padding: 5px 10px; margin: 0; font-size: 1.5rem; background: transparent; border: none; color: var(--text-color);">&times;</button>
            </div>
             <div id="analyticsFilterContainer">
                <label for="analyticsColumnSelector">عرض تحليل لـ:</label>
                <select id="analyticsColumnSelector">
                    </select>
            </div>
            <div class="analytics-content-wrapper"> 
                <div class="special-analytics-grid">
                    <div class="analytics-section">
                        <h3>📉 بحاجة لدعم</h3>
                        <ul id="needsSupportList" class="stats-list"></ul>
                    </div>
                    <div class="analytics-section">
                        <h3>📈 الأفضل</h3>
                        <ul id="topStudentsList" class="stats-list"></ul>
                    </div>
                </div>
                <div class="analytics-section">
                    <h3>إحصائيات عامة</h3>
                    <div class="analytics-stats" id="generalStats">
                        <div class="stat-card">
                            <strong id="totalStudentsStat">0</strong>
                            <span>إجمالي الطلاب</span>
                        </div>
                        <div class="stat-card">
                            <strong id="passedStudentsStat">0</strong>
                            <span>الناجحون</span>
                        </div>
                        <div class="stat-card">
                            <strong id="failedStudentsStat">0</strong>
                            <span>الراسبون</span>
                        </div>
                        <div class="stat-card">
                            <strong id="successPercentageStat">-</strong>
                            <span>نسبة النجاح</span>
                        </div>
                        <div class="stat-card">
                            <strong id="highestGradeStat">-</strong>
                            <span>أعلى درجة</span>
                        </div>
                        <div class="stat-card">
                            <strong id="lowestGradeStat">-</strong>
                            <span>أقل درجة</span>
                        </div>
                        <div class="stat-card">
                            <strong id="stdDevStat">-</strong>
                            <span>الانحراف المعياري</span>
                            <p id="stdDevInterpretation">-</p>
                        </div>
                    </div>
                </div>
                <div class="analytics-section">
                    <h3>توزيع الدرجات</h3>
                    <div id="gradeDistributionChartContainer">
                        <canvas id="gradeDistributionChart"></canvas>
                    </div>
                </div>
                <div class="analytics-section" id="individualStudentAnalyticsSection">
                    <h3>تحليل درجات الطالب</h3>
                    <div class="form-select-container">
                        <label for="selectStudentForChart"></label>
                        <select id="selectStudentForChart"></select>
                    </div>
                    <div id="individualStudentChartContainer">
                        <div id="individualStudentChartPlaceholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--secondary-color);">
                            <p>اختر طالبًا من القائمة أعلاه لعرض تحليله.</p>
                        </div>
                        <canvas id="individualStudentGradeChart" style="display: none;"></canvas>
                    </div>
                </div>
            </div>
             <div class="analytics-footer">
                <button id="printAnalyticsBtn" class="btn btn-info">طباعة التقرير</button>
            </div>
        </div>
    </div>
    
    <div id="recycleBinModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink:0;">
                 <h3 style="text-align:center; color: var(--dark-color); margin:0; flex-grow:1;">سلة المهملات (الشُعب المحذوفة)</h3>
                 <span id="closeRecycleBinModal" class="close-modal-btn" style="float:none;">&times;</span>
            </div>
            <div class="modal-content-body">
                <p style="font-size: 0.8rem; text-align:center; color: var(--secondary-color); margin-bottom: 10px;">الشعب هنا يتم حذفها نهائياً بعد 30 يوم.</p>
                
                <div id="bin-select-all-container" style="display: none; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="bin-select-all-checkbox">
                        <span style="margin-right: 8px;">تحديد الكل</span>
                    </label>
                </div>

                <div id="recycle-bin-list">
                    </div>
            </div>
            <div id="bin-actions-footer" class="modal-actions-footer" style="display: none;">
                <button id="restoreSelectedSectionsBtn" class="btn btn-success" disabled>استعادة المحدد</button>
                <button id="deleteSelectedSectionsBtn" class="btn btn-danger" disabled>حذف المحدد نهائياً</button>
            </div>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink:0;">
                <h3 style="text-align:center; color: var(--dark-color); margin:0; flex-grow:1;">خيارات التصدير</h3>
                <span id="closeExportModal" class="close-modal-btn" style="float:none;">&times;</span>
           </div>
           <div class="modal-content-body" style="text-align: center;">
               <p style="margin-bottom: 20px;">اختر نوع التصدير.</p>
               <button id="exportCurrentBtn" class="btn btn-info" style="width: 80%; margin-bottom: 10px; font-size: 1rem;">تصدير حالي</button>
               <button id="exportAllBtn" class="btn btn-primary" style="width: 80%; font-size: 1rem;">تصدير كلي</button>
           </div>
        </div>
    </div>
    <div id="studentRecycleBinModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink:0;">
                 <h3 style="text-align:center; color: var(--dark-color); margin:0; flex-grow:1;">محذوفات الطلاب</h3>
                 <span id="closeStudentRecycleBinModal" class="close-modal-btn" style="float:none;">&times;</span>
            </div>
            <div class="modal-content-body">
                <p style="font-size: 0.8rem; text-align:center; color: var(--secondary-color); margin-bottom: 10px;">العناصر هنا يتم حذفها نهائياً بعد 7 أيام.</p>
                
                <div id="student-bin-select-all-container" style="display: none; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="student-bin-select-all-checkbox">
                        <span style="margin-right: 8px;">تحديد الكل</span>
                    </label>
                </div>

                <div id="student-recycle-bin-list">
                    </div>
            </div>
            <div id="student-bin-actions-footer" class="modal-actions-footer" style="display: none;">
                <button id="restoreSelectedStudentsBtn" class="btn btn-success" disabled>استعادة المحدد</button>
                <button id="deleteSelectedStudentsBtn" class="btn btn-danger" disabled>حذف المحدد نهائياً</button>
            </div>
        </div>
    </div>

    <div id="addMultipleStudentsModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink:0;">
                 <h3 style="text-align:center; color: var(--dark-color); margin:0; flex-grow:1;">إضافة طلاب جدد</h3>
                 <span id="closeAddMultipleModal" class="close-modal-btn" style="float:none;">&times;</span>
            </div>
            <div class="modal-content-body">
                <p style="margin-bottom: 15px; text-align:center;">العدد المطلوب من 1 - 100:</p>

<div style="text-align: center;">
  <input type="number" id="addMultipleStudentsInput" value="1" min="1" max="100" style="font-size: 1.1rem; padding: 8px; height: auto; width: 100px; text-align: center;">
</div>
            </div>
            <div style="text-align: center; padding-top:15px; flex-shrink:0;">
                <button id="confirmAddMultipleBtn" class="btn btn-primary">إضافة</button>
            </div>
        </div>
    </div>
    <div id="successIndicator" class="success-indicator">
        <div class="success-indicator-circle">
            <span class="success-indicator-checkmark">✓</span>
        </div>
    </div>
    <template id="studentRowTemplate">
        <tr class="student-row">
            <td class="col-name td-sticky"><input type="text" placeholder="اسم الطالب" class="student-name"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="s1m1 grade-input"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="s1m2 grade-input"></td>
            <td class="td-default-width elementary-only-cell"><input type="number" min="0" max="100" placeholder="0" class="s1m3 grade-input"></td>
            <td class="td-default-width"><input type="number" readonly class="s1-final calculated-grade s1-final-bg-color"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="mid-year grade-input"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="s2m1 grade-input"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="s2m2 grade-input"></td>
            <td class="td-default-width"><input type="number" readonly class="s2-final calculated-grade s2-final-bg-color"></td>
            <td class="td-default-width"><input type="number" readonly class="annual-effort calculated-grade annual-effort-bg-color"></td>
            <td class="td-default-width"><input type="number" min="0" max="100" placeholder="0" class="final-exam grade-input"></td>
            <td class="td-default-width"><input type="number" readonly class="overall-final calculated-grade overall-final-bg-color"></td>
            <td class="td-default-width action-col">
                <button class="btn btn-delete-row delete-row-btn" title="حذف الطالب" style="background:transparent; border:none; color:var(--danger-color); font-size:1.3rem; padding:0 2px; line-height:1;">🗑️</button>
            </td>
        </tr>
    </template>
    
    <footer class="app-footer">
         <p>&copy; <span id="currentYear"></span> نظام إدارة الدرجات. جميع الحقوق محفوظة.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Start of Variable Declarations ---
            let currentEducationalStage = null; 
            let currentSecondaryBranch = null; 
            let currentGradeKey = null; 
            let currentGradeText = ''; 
            let currentSection = null; 
            let appData = {};
            let isFocusModeActive = false;
            let currentOralTestType = null; // 'mid-year' or 'end-of-year'
            const PASSWORD_KEY = 'academicGradesAppPassword';
            const APP_DATA_KEY = 'multiLevelGradesApp_v28_finalFixes'; 
            const STUDENT_NAME_COL_WIDTH_KEY = 'studentNameColWidth_v28';
            const DARK_MODE_KEY = 'darkModePreference_v28';
            const DEFAULT_SECTION_NAME = "القائمة الرئيسية للصف";

            const pages = document.querySelectorAll('.page');
            const bodyElement = document.body; 
            const academicHeader = document.querySelector('.academic-header');
            const appFooter = document.querySelector('.app-footer');
            const gradesTablePage = document.getElementById('page-grades-table');
            const gradesTableContentWrapper = gradesTablePage.querySelector('.grades-table-content-wrapper');
            const gradesTableHeaderArea = gradesTablePage.querySelector('.grades-table-header-area');
            const gradesTableActionsBar = gradesTablePage.querySelector('.actions-bar');


            const elementaryGradesPage = document.getElementById('page-elementary-grades');
            const intermediateGradesPage = document.getElementById('page-intermediate-grades');
            const secondaryBranchesPage = document.getElementById('page-secondary-branches');
            const secondaryGradesPage = document.getElementById('page-secondary-grades');
            const gradeOptionsPage = document.getElementById('page-grade-options'); 
            const actualSectionManagementPage = document.getElementById('page-actual-section-management'); 
            
            const selectStageElementaryBtn = document.getElementById('select-stage-elementary');
            const selectStageIntermediateBtn = document.getElementById('select-stage-intermediate');
            const selectStageSecondaryBtn = document.getElementById('select-stage-secondary');

            const elementaryGradeButtons = elementaryGradesPage.querySelectorAll('.btn-grade-option');
            const intermediateGradeButtons = intermediateGradesPage.querySelectorAll('.btn-grade-option');
            
            const selectSecondaryScientificBtn = document.getElementById('select-secondary-scientific');
            const selectSecondaryLiteraryBtn = document.getElementById('select-secondary-literary');
            const currentBranchTextSpan = document.getElementById('current-branch-text');
            const secondaryGradeButtons = secondaryGradesPage.querySelectorAll('.secondary-grade-btn');

            const backBtns = document.querySelectorAll('.back-btn');
            
            const enterSectionsBtn = document.getElementById('enter-sections-btn');
            const addSectionMainBtn = document.getElementById('add-section-main-btn');
            const addSectionOptionsDropdown = document.getElementById('add-section-options-dropdown');
            const addSectionOptionsDropdownContent = addSectionOptionsDropdown.querySelector('.dropdown-content');

            const sectionListDiv = document.getElementById('section-list');
            
            const goToMainClassBtn = document.getElementById('go-to-main-class-btn');
            const backToGradeOptionsBtnTable = document.getElementById('backToGradeOptionsBtnTable');

            const gradesTableTitle = document.getElementById('grades-table-title');
            
            const actionsDropdownToggle = document.getElementById('actionsDropdownToggle');
            const actionsDropdownContent = document.getElementById('actionsDropdownContent');
            
            const addStudentManualBtn = document.getElementById('addStudentBtn');
            const importTxtBtn = document.getElementById('import-txt-btn');
            const textToTxtBtn = document.getElementById('text-to-txt-btn');
            const sortAzBtn = document.getElementById('sort-az-btn');
            const sortZaBtn = document.getElementById('sort-za-btn');
            const printPdfBtn = document.getElementById('printBtn'); 
            const previewImageBtn = document.getElementById('previewImageBtn'); 
            const deleteAllStudentsBtn = document.getElementById('deleteAllBtn');
            
            const txtFileInput = document.getElementById('txt-file-input');
            const jsonFileInput = document.getElementById('json-file-input');
            
            const studentsTable = document.getElementById('studentsTable');
            const studentsTableScreenHeader = studentsTable.querySelector('thead.screen-header');
            const s1GroupHeaderScreen = studentsTableScreenHeader.querySelector('.s1-group-header');
            const printHeaderForTable = studentsTable.querySelector('thead.print-header');
            const s1GroupHeaderPrintTemplate = printHeaderForTable.querySelector('.print-s1-group-header');

            const studentsTableBody = studentsTable.getElementsByTagName('tbody')[0];
            const studentRowTemplate = document.getElementById('studentRowTemplate');
            const gradesTableResponsiveContainer = document.getElementById('gradesTableResponsiveContainer');
            const emptyTableMessage = document.getElementById('empty-table-message');
            
            const textToTxtModal = document.getElementById('textToTxtModal');
            const closeTextToTxtModalBtn = document.getElementById('closeTextToTxtModal');
            const textToTxtInputArea = document.getElementById('textToTxtInput');
            const convertToTxtBtn = document.getElementById('convertToTxtBtn');

            const customConfirmModal = document.getElementById('customConfirmModal');
            const customConfirmModalTitle = document.getElementById('customConfirmModalTitle');
            const customConfirmModalMessage = document.getElementById('customConfirmModalMessage');
            const customConfirmModalOk = document.getElementById('customConfirmModalOk');
            const customConfirmModalCancel = document.getElementById('customConfirmModalCancel');
            
            const imagePreviewModal = document.getElementById('imagePreviewModal');
            const previewImage = document.getElementById('previewImage');
            const closeImagePreview = document.getElementById('closeImagePreview');
            const saveImageBtn = document.getElementById('saveImageBtn');

            const showAnalyticsBtn = document.getElementById('showAnalyticsBtn');
            const analyticsModal = document.getElementById('analyticsModal');
            const closeAnalyticsModal = document.getElementById('closeAnalyticsModal');
            const totalStudentsStat = document.getElementById('totalStudentsStat');
            const passedStudentsStat = document.getElementById('passedStudentsStat');
            const failedStudentsStat = document.getElementById('failedStudentsStat');
            const successPercentageStat = document.getElementById('successPercentageStat');
            const highestGradeStat = document.getElementById('highestGradeStat');
            const lowestGradeStat = document.getElementById('lowestGradeStat');
            const gradeDistributionChartCanvas = document.getElementById('gradeDistributionChart').getContext('2d');
            let gradeChartInstance = null;
            const printAnalyticsBtn = document.getElementById('printAnalyticsBtn');
            
            const individualStudentAnalyticsSection = document.getElementById('individualStudentAnalyticsSection');
            const selectStudentForChart = document.getElementById('selectStudentForChart');
            const individualStudentGradeChartCanvas = document.getElementById('individualStudentGradeChart');
            let individualStudentChartInstance = null;

            const needsSupportList = document.getElementById('needsSupportList');
            const topStudentsList = document.getElementById('topStudentsList');
            const analyticsColumnSelector = document.getElementById('analyticsColumnSelector');

            const exportJsonBtn = document.getElementById('export-json-btn');
            const importJsonBtn = document.getElementById('import-json-btn');
            const exportModal = document.getElementById('exportModal');
            const closeExportModalBtn = document.getElementById('closeExportModal');
            const exportCurrentBtn = document.getElementById('exportCurrentBtn');
            const exportAllBtn = document.getElementById('exportAllBtn');

            const developerInfoHamburger = document.getElementById('developerInfoHamburger');
            const developerInfoModal = document.getElementById('developerInfoModal');
            const setPasswordLink = document.getElementById('setPasswordLink');
            const setPasswordModal = document.getElementById('setPasswordModal');
            const passwordInput = document.getElementById('passwordInput');
            const confirmPasswordInput = document.getElementById('confirmPasswordInput');
            const savePasswordBtn = document.getElementById('savePasswordBtn');
            const cancelSetPasswordBtn = document.getElementById('cancelSetPasswordBtn');
            const passwordStrengthStatus = document.getElementById('password-strength-status');
            const loginModal = document.getElementById('loginModal');
            const loginPasswordInput = document.getElementById('loginPasswordInput');
            const loginBtn = document.getElementById('loginBtn');
            // ================== بداية كود ميزة كلمة المرور ==================

            function checkPasswordStrength(password) {
                const hasLetters = /[a-zA-Z]/.test(password) || /[\u0600-\u06FF]/.test(password); // حروف إنجليزية أو عربية
                const hasNumbers = /[0-9]/.test(password);
                const hasSymbols = /[^a-zA-Z0-9\u0600-\u06FF]/.test(password);
                const isLongEnough = password.length >= 8;

                if (isLongEnough && hasLetters && hasNumbers && hasSymbols) {
                    return 'strong';
                }
                if (isLongEnough && ((hasLetters && hasNumbers) || (hasLetters && hasSymbols) || (hasNumbers && hasSymbols))) {
                    return 'medium';
                }
                if (password.length > 0) {
                    return 'weak';
                }
                return 'none'; // لا يوجد إدخال
            }

            function handlePasswordCheck() {
                const password = passwordInput.value;
                const strength = checkPasswordStrength(password);
                const modalContent = setPasswordModal.querySelector('.modal-content');
                modalContent.classList.remove('password-weak', 'password-medium', 'password-strong');
                savePasswordBtn.disabled = false;

                switch (strength) {
                    case 'strong':
                        modalContent.classList.add('password-strong');
                        passwordStrengthStatus.textContent = 'كلمة مرور قوية';
                        passwordStrengthStatus.style.color = 'var(--success-color)';
                        break;
                    case 'medium':
                        modalContent.classList.add('password-medium');
                        passwordStrengthStatus.textContent = 'كلمة مرور متوسطة';
                        passwordStrengthStatus.style.color = 'var(--warning-color)';
                        break;
                    case 'weak':
                        modalContent.classList.add('password-weak');
                        passwordStrengthStatus.textContent = 'كلمة مرور ضعيفة';
                        passwordStrengthStatus.style.color = 'var(--danger-color)';
                        savePasswordBtn.disabled = true;
                        break;
                    default:
                        passwordStrengthStatus.textContent = '';
                        break;
                }
            }

            if(setPasswordLink) {
                setPasswordLink.addEventListener('click', () => {
                    developerInfoModal.classList.remove('active');
                    developerInfoHamburger.classList.remove('active');
                    setPasswordModal.classList.add('active');
                    passwordInput.value = '';
                    confirmPasswordInput.value = '';
                    handlePasswordCheck();
                    updateBodyScrollLock();
                });
            }

            if(cancelSetPasswordBtn) {
                cancelSetPasswordBtn.addEventListener('click', () => {
                    setPasswordModal.classList.remove('active');
                    const modalContent = setPasswordModal.querySelector('.modal-content');
                    modalContent.classList.remove('password-weak', 'password-medium', 'password-strong');
                    updateBodyScrollLock();
                });
            }
            
            if(passwordInput) {
                passwordInput.addEventListener('input', handlePasswordCheck);
            }

            if(savePasswordBtn) {
                savePasswordBtn.addEventListener('click', () => {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    const strength = checkPasswordStrength(password);

                    if (password !== confirmPassword) {
                        showCustomConfirm("كلمتا المرور غير متطابقتين!", "خطأ");
                        return;
                    }

                    if (password.length > 0 && strength === 'weak') {
                        showCustomConfirm("لا يمكن استخدام كلمة مرور ضعيفة.", "خطأ");
                        return;
                    }
                    
                    if (password.length > 0) {
                        localStorage.setItem(PASSWORD_KEY, password);
                        showCustomConfirm("تم حفظ كلمة المرور بنجاح.", "نجاح");
                    } else {
                        localStorage.removeItem(PASSWORD_KEY);
                        showCustomConfirm("تم إزالة كلمة المرور بنجاح.", "نجاح");
                    }
                    
                    setPasswordModal.classList.remove('active');
                    const modalContent = setPasswordModal.querySelector('.modal-content');
                    modalContent.classList.remove('password-weak', 'password-medium', 'password-strong');
                    updateBodyScrollLock();
                });
            }
            
            // ================== نهاية كود ميزة كلمة المرور ===================
            const closeDeveloperInfoModalBtn = document.getElementById('closeDeveloperInfoModalBtn');
            const darkModeToggle = document.getElementById('darkModeToggle');

            const openRecycleBinBtn = document.getElementById('openRecycleBinBtn');
            const recycleBinModal = document.getElementById('recycleBinModal');
            const closeRecycleBinModal = document.getElementById('closeRecycleBinModal');
            const recycleBinList = document.getElementById('recycle-bin-list');
            const successIndicator = document.getElementById('successIndicator');

            let currentConfirmOkCallback = null;
            let currentConfirmCancelCallback = null;
            let currentSortState = { key: null, direction: 'none' };
            
            const analyticsColumnMap = {
                s1m1: "الفصل الأول - شهر 1",
                s1m2: "الفصل الأول - شهر 2",
                s1m3: "الفصل الأول - شهر 3", // Conditional
                s1final: "مجموع ف1",
                midyear: "اختبار منتصف العام",
                s2m1: "الفصل الثاني - شهر 1",
                s2m2: "الفصل الثاني - شهر 2",
                s2final: "مجموع ف2",
                annualeffort: "المجهود السنوي",
                finalexam: "اختبار نهاية العام",
                overallfinal: "المجموع النهائي"
            };

            const arabicLetters = ['أ', 'ب', 'ج', 'د', 'هـ', 'و', 'ز', 'ح', 'ط', 'ي'];
            const englishLetters = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            function applyDarkMode(isDark) {
                bodyElement.classList.toggle('dark-mode', isDark);
                if (darkModeToggle) darkModeToggle.checked = isDark;
                if (analyticsModal.classList.contains('active')) {
                    const students = appData[currentGradeKey]?.[currentSection] || [];
                    if (students.length > 0) {
                        const selectedGradeKey = analyticsColumnSelector.value;
                        calculateAndDisplayAnalytics(students, selectedGradeKey); 
                        if (selectStudentForChart.value && selectStudentForChart.value !== "") {
                             const selectedStudentIndex = parseInt(selectStudentForChart.value, 10);
                             if (!isNaN(selectedStudentIndex) && students[selectedStudentIndex]) {
                                 plotIndividualStudentChart(students[selectedStudentIndex]);
                             }
                        }
                    }
                }
            }

            function toggleDarkMode() {
                const isDark = bodyElement.classList.toggle('dark-mode');
                localStorage.setItem(DARK_MODE_KEY, isDark);
                applyDarkMode(isDark);
            }

            if (darkModeToggle) {
                darkModeToggle.addEventListener('change', toggleDarkMode);
            }
            applyDarkMode(localStorage.getItem(DARK_MODE_KEY) === 'true');

            function navigateToPage(pageId) {
                pages.forEach(page => page.classList.remove('active'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    console.error("Page not found:", pageId, "Defaulting to main selection.");
                    document.getElementById('page-main-selection')?.classList.add('active');
                }
                
                if (pageId === 'page-grades-table' || pageId === 'page-oral-test') {
                    document.body.classList.add('in-grades-page');
                } else {
                    document.body.classList.remove('in-grades-page');
                }
                
                const developerInfoHamburger = document.getElementById('developerInfoHamburger');
                if (developerInfoHamburger) {
                    developerInfoHamburger.style.display = (pageId === 'page-main-selection') ? 'flex' : 'none';
                    if (pageId !== 'page-main-selection') {
                        document.getElementById('developerInfoModal').classList.remove('active');
                        developerInfoHamburger.classList.remove('active');
                    }
                }

                updateBodyScrollLock();
                
                if (pageId === 'page-grades-table' || pageId === 'page-oral-test') {
                    requestAnimationFrame(adjustStickyHeaders); 
                }

                // >>> السطر الجديد المضاف هنا <<<
                if (pageId === 'page-grade-options') {
                    updateGradeOptionsState();
                }
            }

            function updateBodyScrollLock() {
                const isAnyModalActive = !!document.querySelector('.modal.active') || addSectionOptionsDropdown.style.display === 'block';
                bodyElement.classList.toggle('noscroll-page-active', isAnyModalActive || bodyElement.classList.contains('table-editing-mode'));
            }
            
            function loadAppData() {
                const storedData = localStorage.getItem(APP_DATA_KEY);
                appData = storedData ? JSON.parse(storedData) : {};

                if (!appData.recycleBin) appData.recycleBin = {};
                if (!appData.studentRecycleBin) appData.studentRecycleBin = [];
                
                let wasPurged = false;
                const now = Date.now();

                const thirtyDaysInMillis = 30 * 24 * 60 * 60 * 1000;
                for (const uniqueId in appData.recycleBin) {
                    if (now - appData.recycleBin[uniqueId].deletionTimestamp > thirtyDaysInMillis) {
                        delete appData.recycleBin[uniqueId];
                        wasPurged = true;
                    }
                }
                
                const sevenDaysInMillis = 7 * 24 * 60 * 60 * 1000;
                const initialStudentBinLength = appData.studentRecycleBin.length;
                appData.studentRecycleBin = appData.studentRecycleBin.filter(
                    item => (now - item.deletionTimestamp) < sevenDaysInMillis
                );
                if (appData.studentRecycleBin.length < initialStudentBinLength) {
                    wasPurged = true;
                }

                if (wasPurged) {
                    console.log("Purged expired items from recycle bin.");
                }

                const stages = {
                    elementary: ['grade5', 'grade6'],
                    intermediate: ['intermediate1', 'intermediate2', 'intermediate3'],
                    secondary_scientific: ['secondary_scientific_4', 'secondary_scientific_5', 'secondary_scientific_6'],
                    secondary_literary: ['secondary_literary_4', 'secondary_literary_5', 'secondary_literary_6']
                };
                Object.values(stages).flat().forEach(gradeKey => {
                    if (!appData[gradeKey] || typeof appData[gradeKey] !== 'object' || Array.isArray(appData[gradeKey])) {
                        appData[gradeKey] = { [DEFAULT_SECTION_NAME]: [] };
                    } else if (!appData[gradeKey][DEFAULT_SECTION_NAME]) {
                        appData[gradeKey][DEFAULT_SECTION_NAME] = [];
                    }
                });
                const savedWidth = localStorage.getItem(STUDENT_NAME_COL_WIDTH_KEY);
                applyStudentNameColumnWidth(parseInt(savedWidth, 10) || 120);

                if(wasPurged) saveAppData();
            }

            function saveAppData() {
                localStorage.setItem(APP_DATA_KEY, JSON.stringify(appData));
            }
            
            selectStageElementaryBtn.addEventListener('click', () => { currentEducationalStage = 'elementary'; navigateToPage('page-elementary-grades'); });
            selectStageIntermediateBtn.addEventListener('click', () => { currentEducationalStage = 'intermediate'; navigateToPage('page-intermediate-grades'); });
            selectStageSecondaryBtn.addEventListener('click', () => { currentEducationalStage = 'secondary'; navigateToPage('page-secondary-branches'); });

            elementaryGradeButtons.forEach(btn => btn.addEventListener('click', () => selectGradeAndGoToOptions(btn.dataset.gradeKey, btn.dataset.gradeText)));
            intermediateGradeButtons.forEach(btn => btn.addEventListener('click', () => selectGradeAndGoToOptions(btn.dataset.gradeKey, btn.dataset.gradeText)));
            
            selectSecondaryScientificBtn.addEventListener('click', () => selectSecondaryBranch('scientific', 'العلمي'));
            selectSecondaryLiteraryBtn.addEventListener('click', () => selectSecondaryBranch('literary', 'الأدبي'));

            secondaryGradeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const gradeKeyBase = btn.dataset.gradeKeyBase.replace('_X_', `_${currentSecondaryBranch}_`);
                    const gradeTextBase = btn.dataset.gradeTextBase.replace('المسار', currentBranchTextSpan.textContent);
                    selectGradeAndGoToOptions(gradeKeyBase, gradeTextBase);
                });
            });

            function selectSecondaryBranch(branchKey, branchText) {
                currentSecondaryBranch = branchKey;
                currentBranchTextSpan.textContent = branchText;
                navigateToPage('page-secondary-grades');
            }

            function selectGradeAndGoToOptions(gradeKey, gradeText) {
                currentGradeKey = gradeKey;
                currentGradeText = gradeText;
                const currentGradeLevelTextManage = document.getElementById('current-grade-level-text-manage');
                if (currentGradeLevelTextManage) {
                    currentGradeLevelTextManage.textContent = gradeText;
                }

                const titleElement = document.getElementById('grade-options-title');
                if (titleElement) {
                    if (gradeKey.startsWith('secondary_')) {
                        titleElement.textContent = gradeText.replace('الصف ', '');
                        titleElement.classList.add('is-secondary');
                    } else {
                        titleElement.textContent = currentGradeText;
                        titleElement.classList.remove('is-secondary');
                    }
                }

                if (!appData[gradeKey] || typeof appData[gradeKey] !== 'object' || Array.isArray(appData[gradeKey])) {
                    appData[gradeKey] = { [DEFAULT_SECTION_NAME]: [] };
                } else if (!appData[gradeKey][DEFAULT_SECTION_NAME]) {
                    appData[gradeKey][DEFAULT_SECTION_NAME] = [];
                }
                saveAppData(); 
                navigateToPage('page-grade-options');
            }

            backBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const currentPage = btn.closest('.page');
                    if (!currentPage) return navigateToPage('page-main-selection');

                    addSectionOptionsDropdown.style.display = 'none';
                    addSectionMainBtn?.querySelector('.dropdown-arrow')?.classList.remove('open');
                    updateBodyScrollLock();

                    if (['page-elementary-grades', 'page-intermediate-grades', 'page-secondary-branches'].includes(currentPage.id)) {
                        navigateToPage('page-main-selection');
                    } else if (currentPage.id === 'page-secondary-grades') {
                        navigateToPage('page-secondary-branches');
                    } else if (currentPage.id === 'page-grade-options') {
                        if (currentEducationalStage === 'elementary') navigateToPage('page-elementary-grades');
                        else if (currentEducationalStage === 'intermediate') navigateToPage('page-intermediate-grades');
                        else if (currentEducationalStage === 'secondary') navigateToPage('page-secondary-grades');
                        else navigateToPage('page-main-selection'); 
                    } else if (currentPage.id === 'page-actual-section-management') {
                        navigateToPage('page-grade-options');
                    } else if (currentPage.id === 'page-grades-table'){ 
                         saveCurrentSectionData(); 
                         navigateToPage('page-grade-options');
                    } else {
                        navigateToPage('page-main-selection'); 
                    }
                });
            });

            backToGradeOptionsBtnTable.addEventListener('click', () => {
                saveCurrentSectionData();
                resetTableSortAndFilter();
                navigateToPage('page-grade-options');
            });
            
            if (enterSectionsBtn) {
                enterSectionsBtn.addEventListener('click', () => {
                    renderSectionListForManagementPage(); 
                    navigateToPage('page-actual-section-management');
                });
            }
            
            if (addSectionMainBtn) {
                addSectionMainBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = addSectionOptionsDropdown.style.display === 'block';
                    addSectionOptionsDropdown.style.display = isOpen ? 'none' : 'block';
                    if (!isOpen) {
                        populateAddSectionDropdownLanguages();
                    }
                    updateBodyScrollLock();
                });
            }

            function populateAddSectionDropdownLanguages() {
                if (!addSectionOptionsDropdownContent) return;
                addSectionOptionsDropdownContent.innerHTML = ''; 
                const langHeader = document.createElement('div');
                langHeader.className = 'language-options-header dropdown-item';
                langHeader.textContent = 'اختر لغة الشعبة';
                addSectionOptionsDropdownContent.appendChild(langHeader);

                const arabicOption = document.createElement('button');
                arabicOption.className = 'dropdown-item';
                arabicOption.textContent = 'عربي';
                arabicOption.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    populateAddSectionDropdownLetters('arabic');
                });
                addSectionOptionsDropdownContent.appendChild(arabicOption);

                const englishOption = document.createElement('button');
                englishOption.className = 'dropdown-item';
                englishOption.textContent = 'English';
                englishOption.addEventListener('click', (e) => {
                    e.stopPropagation();
                    populateAddSectionDropdownLetters('english');
                });
                addSectionOptionsDropdownContent.appendChild(englishOption);
            }

            function populateAddSectionDropdownLetters(language) {
                if (!addSectionOptionsDropdownContent) return;
                addSectionOptionsDropdownContent.innerHTML = ''; 

                const letters = language === 'arabic' ? arabicLetters : englishLetters;
                const existingSectionNames = currentGradeKey && appData[currentGradeKey] ? Object.keys(appData[currentGradeKey]) : [];
                const sectionBaseName = language === 'arabic' ? 'الشعبة' : 'Section';

                // --- بداية المنطق الجديد: البحث عن الشعبة التالية المتاحة ---
                let nextLetter = null;
                for (const letter of letters) {
                    const potentialSectionName = `${sectionBaseName} ${letter}`;
                    if (!existingSectionNames.includes(potentialSectionName)) {
                        nextLetter = letter;
                        break;
                    }
                }
                // --- نهاية المنطق الجديد ---
                
                letters.forEach(letter => {
                    const newSectionName = `${sectionBaseName} ${letter}`;
                    const letterItem = document.createElement('button');
                    letterItem.className = 'dropdown-item';
                    letterItem.textContent = letter;
                    
                    if (existingSectionNames.includes(newSectionName)) {
                        // إذا كانت الشعبة موجودة بالفعل، يتم تعطيلها
                        letterItem.disabled = true;
                        letterItem.title = "هذه الشعبة موجودة بالفعل";
                    } else {
                        // إذا لم تكن موجودة، تحقق إذا كانت هي التالية في الدور
                        if (letter === nextLetter) {
                            // هذه هي الشعبة الصحيحة، يتم تفعيلها
                            letterItem.addEventListener('click', (e) => {
                                e.stopPropagation();
                                addNewSectionFromDropdown(newSectionName);
                                // بعد الإضافة، نعيد بناء القائمة لتحديد الشعبة التالية
                                populateAddSectionDropdownLetters(language); 
                            });
                        } else {
                            // هذه ليست الشعبة التالية، يتم تعطيلها
                            letterItem.disabled = true;
                            letterItem.title = "يجب إضافة الشعب بالتسلسل";
                        }
                    }
                    addSectionOptionsDropdownContent.appendChild(letterItem);
                });
            }

            function addNewSectionFromDropdown(sectionName) {
                if (!currentGradeKey) { showCustomConfirm("لم يتم تحديد الصف الدراسي.", "خطأ"); return; }
                if (!appData[currentGradeKey]) appData[currentGradeKey] = { [DEFAULT_SECTION_NAME]: [] };
                if (appData[currentGradeKey][sectionName]) { 
                    return; 
                }
                
                appData[currentGradeKey][sectionName] = []; 
                saveAppData();
                updateGradeOptionsState(); // <<< السطر الجديد المضاف هنا
            }
            
            function renderSectionListForManagementPage() {
                if (!sectionListDiv || !currentGradeKey || !appData[currentGradeKey]) {
                    if (sectionListDiv) sectionListDiv.innerHTML = '<p style="text-align:center; color:grey; margin-top:10px;">لا توجد شعب لعرضها. قم بإضافة شعبة من صفحة خيارات الصف.</p>';
                    return;
                }
                sectionListDiv.innerHTML = ''; 
                const sections = Object.keys(appData[currentGradeKey])
                                     .filter(name => name !== DEFAULT_SECTION_NAME); 

                if (sections.length === 0 ) {
                     sectionListDiv.innerHTML = '<p style="text-align:center; color:grey; margin-top:10px;">لا توجد شعب مضافة. يمكنك إضافة شعبة من صفحة خيارات الصف.</p>';
                } else {
                    sections.sort((a, b) => a.localeCompare(b, 'ar')) 
                            .forEach(sectionName => {
                        const sectionItem = document.createElement('div');
                        sectionItem.classList.add('section-list-item');

                        const nameSpan = document.createElement('span');
                        nameSpan.classList.add('section-name');
                        nameSpan.textContent = sectionName; 
                        nameSpan.title = `الذهاب إلى ${sectionName}`;
                        nameSpan.addEventListener('click', () => {
                            currentSection = sectionName;
                            renderStudentsTable();
                            navigateToPage('page-grades-table');
                        });
                        sectionItem.appendChild(nameSpan);

                        const deleteIcon = document.createElement('span');
                        deleteIcon.classList.add('delete-section-icon');
                        deleteIcon.innerHTML = '&#x2716;'; 
                        deleteIcon.title = `حذف شعبة ${sectionName}`;
                        deleteIcon.addEventListener('click', (e) => {
                            e.stopPropagation(); 
                            showCustomConfirm(
                                `هل أنت متأكد من نقل الشعبة "${sectionName}" إلى سلة المهملات؟`,
                                "تأكيد الحذف",
                                () => {
                                    if (!appData.recycleBin) appData.recycleBin = {};
                                    const uniqueId = `${currentGradeKey}||${sectionName}`;
                                    
                                    appData.recycleBin[uniqueId] = {
                                        gradeKey: currentGradeKey,
                                        gradeText: currentGradeText,
                                        sectionName: sectionName,
                                        students: appData[currentGradeKey][sectionName],
                                        deletionTimestamp: Date.now()
                                    };

                                    delete appData[currentGradeKey][sectionName];
                                    
                                    saveAppData();
                                    renderSectionListForManagementPage();
                                    updateGradeOptionsState(); // <<< السطر الجديد المضاف هنا
                                    showCustomConfirm(`تم نقل الشعبة "${sectionName}" إلى سلة المهملات.`, "تم النقل");
                                }
                            );
                        });
                        sectionItem.appendChild(deleteIcon);
                        sectionListDiv.appendChild(sectionItem);
                    });
                }
            }

            if (goToMainClassBtn) {
                goToMainClassBtn.addEventListener('click', () => {
                    currentSection = DEFAULT_SECTION_NAME;
                    renderStudentsTable();
                    navigateToPage('page-grades-table');
                });
            }
            
            function isElementaryStage(gradeKeyToCheck) {
                return gradeKeyToCheck && (gradeKeyToCheck.startsWith('grade')); 
            }

            function adjustStickyHeaders() {
                if (!studentsTableScreenHeader) return;
                const firstHeaderRow = studentsTableScreenHeader.querySelector('tr:first-child');
                if (firstHeaderRow) {
                    const firstHeaderRowHeight = firstHeaderRow.offsetHeight;
                    studentsTableScreenHeader.querySelectorAll('tr:nth-child(2) th').forEach(th => {
                        th.style.top = `${firstHeaderRowHeight}px`;
                    });
                    const studentNameHeaderSecondRow = studentsTableScreenHeader.querySelector('tr:nth-child(2) .th-sticky');
                    if (studentNameHeaderSecondRow) {
                        studentNameHeaderSecondRow.style.top = `${firstHeaderRowHeight}px`;
                    }
                }
            }
            window.addEventListener('resize', () => requestAnimationFrame(adjustStickyHeaders));


            function renderStudentsTable() {
                if (!currentGradeKey || !currentSection) return;
                
                resetTableSortAndFilter();

                const isElem = isElementaryStage(currentGradeKey);
                document.querySelectorAll('.elementary-only-cell').forEach(cell => {
                    cell.style.display = isElem ? '' : 'none';
                });

                if (s1GroupHeaderScreen) s1GroupHeaderScreen.colSpan = isElem ? 4 : 3;
                if (s1GroupHeaderPrintTemplate) s1GroupHeaderPrintTemplate.colSpan = isElem ? 4 : 3; 
                
                studentsTableBody.innerHTML = ''; 
                if (!appData[currentGradeKey]) appData[currentGradeKey] = { [DEFAULT_SECTION_NAME]: [] }; 
                if (!appData[currentGradeKey][currentSection]) appData[currentGradeKey][currentSection] = []; 
                
                const students = appData[currentGradeKey][currentSection];

                if (students.length === 0) {
                    studentsTable.style.display = 'none';
                    emptyTableMessage.style.display = 'block';
                } else {
                    studentsTable.style.display = 'table';
                    emptyTableMessage.style.display = 'none';
                    students.forEach((student, index) => {
                        addStudentRowToDOM(student, index + 1, student.isImported);
                    });
                }
                updateRowNumbers(); 
                requestAnimationFrame(adjustStickyHeaders); 
                updateOralTestButtonState(); // <<< هذا هو السطر الجديد في مكانه الصحيح 
            }

             function addStudentRowToDOM(studentData = null, rowNumber, isImported = false) {
                const isElem = isElementaryStage(currentGradeKey);
                const newRowTemplateContent = document.getElementById('studentRowTemplate').content.cloneNode(true);
                const rowElement = newRowTemplateContent.querySelector('tr');

                const noCell = document.createElement('td');
                noCell.classList.add('col-no-cell', 'td-default-width', 'col-no'); 
                noCell.style.textAlign = 'center';
                noCell.textContent = rowNumber;
                rowElement.insertBefore(noCell, rowElement.firstChild); 
                
                const nameCell = rowElement.querySelector('.col-name'); 
                const studentNameInput = nameCell.querySelector('.student-name');

                if (nameCell) { 
                    const currentNameColHeader = document.querySelector('#studentsTable thead.screen-header .th-student-name');
                    let currentNameColWidth = '120px'; 
                    if (currentNameColHeader) {
                        currentNameColWidth = currentNameColHeader.style.minWidth || getComputedStyle(currentNameColHeader).minWidth || '120px';
                    }
                    nameCell.style.minWidth = currentNameColWidth;
                    nameCell.style.width = currentNameColWidth;
                }
                
                const s1m3CellInTemplate = rowElement.querySelector('.elementary-only-cell');
                if (s1m3CellInTemplate) s1m3CellInTemplate.style.display = isElem ? '' : 'none';

                if (studentData) {
                    studentNameInput.value = studentData.name || '';
                    studentNameInput.readOnly = studentData.isImported || (studentData.name && studentData.name.trim() !== '');
                    rowElement.querySelector('.s1m1').value = studentData.s1m1 || '';
                    rowElement.querySelector('.s1m2').value = studentData.s1m2 || '';
                    if (isElem) rowElement.querySelector('.s1m3').value = studentData.s1m3 || '';
                    rowElement.querySelector('.mid-year').value = studentData.midyear || ''; 
                    rowElement.querySelector('.s2m1').value = studentData.s2m1 || '';
                    rowElement.querySelector('.s2m2').value = studentData.s2m2 || '';
                    rowElement.querySelector('.final-exam').value = studentData.finalexam || ''; 
                }
                
                rowElement.querySelectorAll('input').forEach(input => { 
                    input.addEventListener('focus', (event) => {
                        document.body.classList.add('table-editing-mode');
                    });
                    input.addEventListener('blur', () => {
                        setTimeout(() => {
                            if (!document.querySelector('#page-grades-table input:focus')) {
                                document.body.classList.remove('table-editing-mode');
                            }
                        }, 0);
                    });

                    if (input.classList.contains('grade-input')) {
                        input.addEventListener('input', (e) => {
                            // --- الكود الجديد الذي يعيد الميزة المفقودة ---
                            let value = parseFloat(input.value);
                            if (!isNaN(value) && value > 100) {
                                input.value = '100';
                            }
                            // --- نهاية الكود الجديد ---
                            
                            calculateGradesForRow(rowElement);
                            saveCurrentSectionData();
                        });
                        input.addEventListener('blur', handleGradeInputValidation); 
                    } else if (input.classList.contains('student-name') && !input.readOnly) { 
                        input.addEventListener('input', (e) => {
                            saveCurrentSectionData(); 
                        });
                        input.addEventListener('blur', () => {
                            if (input.value.trim() !== '') {
                                input.readOnly = true;
                                saveCurrentSectionData(); 
                            }
                        });
                    }

                    if (input.classList.contains('student-name')) {
                        input.addEventListener('click', (e) => {
                            if (isFocusModeActive) {
                                const row = e.target.closest('.student-row');
                                if (row.classList.contains('is-focused')) {
                                    clearAllRowFocus();
                                } else {
                                    setRowFocus(row);
                                }
                                e.stopPropagation();
                            }
                        });
                    }
                });

                const deleteBtn = rowElement.querySelector('.delete-row-btn');
                deleteBtn.addEventListener('click', function() {
                    const rowToDelete = this.closest('tr');
                    const studentName = rowToDelete.querySelector('.student-name').value.trim() || 'هذا الطالب';
                    showCustomConfirm(
                        `هل أنت متأكد من نقل الطالب "${studentName}" إلى المحذوفات؟`,
                        "تأكيد النقل للمحذوفات",
                        () => { 
                            const studentsTableBody = document.getElementById('studentsTable').getElementsByTagName('tbody')[0];
                            const rowIndex = Array.from(studentsTableBody.children).indexOf(rowToDelete);
                            const students = appData[currentGradeKey]?.[currentSection];

                            if (rowIndex > -1 && students) {
                                const studentData = students[rowIndex];
                                if (!appData.studentRecycleBin) appData.studentRecycleBin = [];
                                appData.studentRecycleBin.push({
                                    studentData: studentData,
                                    gradeKey: currentGradeKey,
                                    sectionName: currentSection,
                                    deletionTimestamp: Date.now()
                                });
                                students.splice(rowIndex, 1);
                                
                                rowToDelete.classList.add('row-deleting');
                                rowToDelete.addEventListener('animationend', () => {
                                    rowToDelete.remove();
                                    updateRowNumbers(); 
                                    saveAppData();
                                    if (studentsTableBody.children.length === 0) {
                                        renderStudentsTable();
                                    }
                                    updateOralTestButtonState();
                                });
                            }
                        }
                    );
                });

                document.getElementById('studentsTable').getElementsByTagName('tbody')[0].appendChild(rowElement);
                if (studentData) calculateGradesForRow(rowElement); 
                updateOralTestButtonState();
            }
             function saveCurrentSectionData() { 
                if (!currentGradeKey || !currentSection || !appData[currentGradeKey]) return;
                const isElem = isElementaryStage(currentGradeKey);
                const studentsInTable = Array.from(studentsTableBody.querySelectorAll('tr.student-row')).map(row => {
                    const nameInput = row.querySelector('.student-name');
                    return {
                        name: nameInput.value.trim(),
                        isImported: nameInput.readOnly,
                        s1m1: row.querySelector('.s1m1').value, s1m2: row.querySelector('.s1m2').value,
                        s1m3: isElem ? row.querySelector('.s1m3').value : '', 
                        midyear: row.querySelector('.mid-year').value, 
                        s2m1: row.querySelector('.s2m1').value, s2m2: row.querySelector('.s2m2').value,
                        finalexam: row.querySelector('.final-exam').value, 
                        s1final: row.querySelector('.s1-final').value,
                        s2final: row.querySelector('.s2-final').value,
                        annualeffort: row.querySelector('.annual-effort').value,
                        overallfinal: row.querySelector('.overall-final').value
                    };
                });
                if (!appData[currentGradeKey]) appData[currentGradeKey] = {};
                appData[currentGradeKey][currentSection] = studentsInTable;
                saveAppData(); 
            }

            function handleGradeInputValidation(event) {
                if (!event.target || typeof event.target.value === 'undefined') return;
                let valueStr = event.target.value.trim();
                const originalValueStr = valueStr; 

                if (valueStr === '') return; 

                let value = parseFloat(valueStr);

                if (isNaN(value)) { 
                    event.target.value = ''; 
                } else if (value < 0) {
                    event.target.value = '0'; 
                } else if (value > 100) {
                    event.target.value = '100'; 
                }
                
                if (event.target.value !== originalValueStr) {
                    const row = event.target.closest('tr');
                    if (row) {
                        calculateGradesForRow(row); 
                        saveCurrentSectionData();   
                    }
                }
            }

            function applyConditionalFormatting(inputElement, value, defaultBgClassKey) {
                if (!inputElement) return;
                inputElement.classList.remove('grade-fail', 'grade-excellent', 's1-final-bg-color', 's2-final-bg-color', 'annual-effort-bg-color', 'overall-final-bg-color');
                let appliedFormatClass = defaultBgClassKey; 
                if (value !== '' && !isNaN(value)) {
                    const valNum = parseFloat(value);
                    if (valNum < 50 ) { 
                        appliedFormatClass = 'grade-fail';
                    } else if (valNum >= 47 && valNum <= 49) { 
                         appliedFormatClass = 'grade-fail'; 
                    } else if (valNum >= 90) { 
                        appliedFormatClass = 'grade-excellent';
                    }
                }
                if(appliedFormatClass && value !== '') inputElement.classList.add(appliedFormatClass);
                else if (value === '') inputElement.classList.add(defaultBgClassKey); 
            }

            function calculateGradesForRow(row) {
                const getValStr = (selector) => row.querySelector(selector)?.value.trim() || '';
                const setVal = (selector, value) => { 
                    const f = row.querySelector(selector); 
                    if (f) f.value = (value === '' || isNaN(value)) ? '' : value; 
                };
                const customRound = (num) => (num === '' || isNaN(num)) ? '' : Math.round(parseFloat(num));
                const isElem = isElementaryStage(currentGradeKey);

                const s1m1Str = getValStr('.s1m1');
                const s1m2Str = getValStr('.s1m2');
                const s1m3Str = isElem ? getValStr('.s1m3') : '';
                let s1Final = '';
                let s1PrerequisitesMet = (s1m1Str !== '' && s1m2Str !== '');
                if (isElem) s1PrerequisitesMet = s1PrerequisitesMet && (s1m3Str !== '');
                if (s1PrerequisitesMet) {
                    const s1m1Num = parseFloat(s1m1Str); const s1m2Num = parseFloat(s1m2Str);
                    const s1ValuesForCalc = [s1m1Num, s1m2Num];
                    if (isElem) { const s1m3Num = parseFloat(s1m3Str); s1ValuesForCalc.push(s1m3Num); }
                    if (s1ValuesForCalc.every(n => !isNaN(n))) s1Final = customRound(s1ValuesForCalc.reduce((a, b) => a + b, 0) / s1ValuesForCalc.length);
                }
                setVal('.s1-final', s1Final); applyConditionalFormatting(row.querySelector('.s1-final'), s1Final, 's1-final-bg-color');

                const s2m1Str = getValStr('.s2m1'); const s2m2Str = getValStr('.s2m2');
                let s2Final = '';
                const s2PrerequisitesMet = (s2m1Str !== '' && s2m2Str !== '');
                if (s2PrerequisitesMet) {
                    const s2m1Num = parseFloat(s2m1Str); const s2m2Num = parseFloat(s2m2Str);
                    if (!isNaN(s2m1Num) && !isNaN(s2m2Num)) s2Final = customRound((s2m1Num + s2m2Num) / 2);
                }
                setVal('.s2-final', s2Final); applyConditionalFormatting(row.querySelector('.s2-final'), s2Final, 's2-final-bg-color');

                const midYearStr = getValStr('.mid-year');
                const s1FinalValStr = getValStr('.s1-final'); const s2FinalValStr = getValStr('.s2-final'); 
                let annualEffort = '';
                const annualPrerequisitesMet = (s1FinalValStr !== '' && midYearStr !== '' && s2FinalValStr !== '');
                if (annualPrerequisitesMet) {
                    const s1FinalNum = parseFloat(s1FinalValStr); const midYearNum = parseFloat(midYearStr); const s2FinalNum = parseFloat(s2FinalValStr);
                    if (!isNaN(s1FinalNum) && !isNaN(midYearNum) && !isNaN(s2FinalNum)) annualEffort = customRound((s1FinalNum + midYearNum + s2FinalNum) / 3);
                }
                setVal('.annual-effort', annualEffort); applyConditionalFormatting(row.querySelector('.annual-effort'), annualEffort, 'annual-effort-bg-color');
                
                const finalExamStr = getValStr('.final-exam');
                const annualEffortValStr = getValStr('.annual-effort'); 
                let overallFinal = '';
                const overallPrerequisitesMet = (annualEffortValStr !== '' && finalExamStr !== '');
                if (overallPrerequisitesMet) {
                    const annualEffortNum = parseFloat(annualEffortValStr); const finalExamNum = parseFloat(finalExamStr);
                    if (!isNaN(annualEffortNum) && !isNaN(finalExamNum)) overallFinal = customRound((annualEffortNum + finalExamNum) / 2);
                }
                setVal('.overall-final', overallFinal); applyConditionalFormatting(row.querySelector('.overall-final'), overallFinal, 'overall-final-bg-color'); 
            }


             function updateRowNumbers() {
                studentsTableBody.querySelectorAll('tr.student-row').forEach((row, index) => {
                    let noCell = row.querySelector('.col-no'); 
                    if (!noCell && row.firstChild?.tagName === 'TD') { 
                       noCell = row.firstChild;
                    }
                    if (noCell) {
                         noCell.textContent = index + 1;
                    }
                });
            }
            
            function applyStudentNameColumnWidth(widthPx, tableSelector) {
                if (!tableSelector) return; // التأكد من وجود محدد للجدول

                const headerCellToStyle = document.querySelector(`${tableSelector} thead.screen-header .th-student-name`);
                const headerTextCellToStyle = document.querySelector(`${tableSelector} thead.screen-header .student-name-header-text-container`);

                if (!headerCellToStyle) return 120; 

                const safeWidth = Math.max(100, Math.min(400, widthPx)); 
                headerCellToStyle.style.minWidth = `${safeWidth}px`;
                headerCellToStyle.style.width = `${safeWidth}px`;
                
                if(headerTextCellToStyle) { // قد لا يكون موجوداً في الجدول الجديد
                    headerTextCellToStyle.style.minWidth = `${safeWidth}px`;
                    headerTextCellToStyle.style.width = `${safeWidth}px`;
                }

                document.querySelectorAll(`${tableSelector} tbody .col-name`).forEach(cell => {
                    cell.style.minWidth = `${safeWidth}px`;
                    cell.style.width = `${safeWidth}px`;
                });
                return safeWidth; 
            }

            window.adjustStudentNameColumnWidth = function(increase) { 
                const activePage = document.querySelector('.page.active');
                let tableSelector;
                if (activePage) {
                    if (activePage.id === 'page-grades-table') {
                        tableSelector = '#studentsTable';
                    } else if (activePage.id === 'page-oral-test') {
                        tableSelector = '#oralTestTable';
                    }
                }
                if (!tableSelector) return;

                const currentHeaderCell = document.querySelector(`${tableSelector} thead.screen-header .th-student-name`);
                if (!currentHeaderCell) return;

                let currentMinWidth = 120; 
                if (currentHeaderCell.style.minWidth && currentHeaderCell.style.minWidth.endsWith('px')) {
                    currentMinWidth = parseInt(currentHeaderCell.style.minWidth, 10);
                } else { 
                    const computedMinWidth = parseInt(getComputedStyle(currentHeaderCell).minWidth, 10);
                    if (!isNaN(computedMinWidth)) {
                        currentMinWidth = computedMinWidth;
                    }
                }
                
                const changeAmount = 25; 
                let newMinWidth = currentMinWidth + (increase ? changeAmount : -changeAmount);
                
                const appliedClampedWidth = applyStudentNameColumnWidth(newMinWidth, tableSelector); 
                localStorage.setItem(STUDENT_NAME_COL_WIDTH_KEY, appliedClampedWidth);
            }


            if(actionsDropdownToggle && actionsDropdownContent) {
                actionsDropdownToggle.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    const isOpen = actionsDropdownContent.classList.toggle('active'); 
                    actionsDropdownToggle.querySelector('.dropdown-arrow').classList.toggle('open', isOpen);
                });
            }
            

            if (printPdfBtn) { 
                printPdfBtn.disabled = true; 
                printPdfBtn.title = "تحميل PDF غير متاح حالياً";
            }
            
            // الكود الجديد لفتح نافذة إضافة عدد الطلاب
            const addMultipleStudentsModal = document.getElementById('addMultipleStudentsModal');
            const closeAddMultipleModalBtn = document.getElementById('closeAddMultipleModal');
            const confirmAddMultipleBtn = document.getElementById('confirmAddMultipleBtn');
            const addMultipleStudentsInput = document.getElementById('addMultipleStudentsInput');

            if (addStudentManualBtn) {
                addStudentManualBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active'); 
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    if (!currentGradeKey || !currentSection) {
                        showCustomConfirm("يرجى تحديد الصف والشعبة أولاً.", "تنبيه");
                        return;
                    }
                    addMultipleStudentsInput.value = '1'; // إعادة التعيين إلى القيمة الافتراضية
                    addMultipleStudentsModal.classList.add('active');
                    updateBodyScrollLock();
                });
            }
            if(closeAddMultipleModalBtn) {
                closeAddMultipleModalBtn.addEventListener('click', () => {
                    addMultipleStudentsModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }
            if(confirmAddMultipleBtn) {
                confirmAddMultipleBtn.addEventListener('click', () => {
                    const count = parseInt(addMultipleStudentsInput.value, 10);
                    
                    if (isNaN(count) || count < 1 || count > 100) {
                        const addMultipleStudentsInput = document.getElementById('addMultipleStudentsInput');
                        addMultipleStudentsInput.style.border = '2px solid var(--danger-color)'; 
                        setTimeout(() => {
                            addMultipleStudentsInput.style.border = '';
                        }, 1500);
                        return;
                    }

                    studentsTable.style.display = 'table';
                    emptyTableMessage.style.display = 'none';

                    for (let i = 0; i < count; i++) {
                        addStudentRowToDOM(null, document.getElementById('studentsTable').getElementsByTagName('tbody')[0].rows.length + 1, false);
                    }
                    saveCurrentSectionData();

                    addMultipleStudentsModal.classList.remove('active');
                    updateBodyScrollLock();
                    updateOralTestButtonState(); // <<< هذا هو السطر الجديد المهم
                });
            }
            
            if (importTxtBtn && txtFileInput) {
                importTxtBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                     actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    txtFileInput.click(); 
                });

                txtFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const names = e.target.result.split(/[\r\n]+/)
                                .map(name => name.trim())
                                .filter(name => name); 

                            if (names.length > 0) {
                                document.getElementById('studentsTable').style.display = 'table';
                                document.getElementById('empty-table-message').style.display = 'none';

                                names.forEach(name => {
                                    addStudentRowToDOM({ name: name }, document.getElementById('studentsTable').getElementsByTagName('tbody')[0].rows.length + 1, true);
                                });
                                saveCurrentSectionData(); 
                                showCustomConfirm(`تم استيراد ${names.length} أسماء بنجاح. الأسماء المستوردة غير قابلة للتعديل.`, "تم الاستيراد");
                                
                                requestAnimationFrame(adjustStickyHeaders);
                                updateOralTestButtonState(); // <<< هذا هو السطر الجديد المهم
                            } else {
                                showCustomConfirm("الملف فارغ أو لا يحتوي على أسماء صالحة.", "خطأ في الملف");
                            }
                        };
                        reader.onerror = () => showCustomConfirm("فشل في قراءة الملف.", "خطأ");
                        reader.readAsText(file, 'UTF-8'); 
                        txtFileInput.value = ''; 
                    }
                });
            }

            if (textToTxtBtn && textToTxtModal && textToTxtInputArea) {
                textToTxtBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    textToTxtModal.classList.add('active'); 
                    updateBodyScrollLock();
                    textToTxtInputArea.value = ''; 
                    textToTxtInputArea.focus();
                });
            }
            if (closeTextToTxtModalBtn && textToTxtModal) {
                 closeTextToTxtModalBtn.addEventListener('click', () => {
                     textToTxtModal.classList.remove('active'); 
                     updateBodyScrollLock();
                 });
            }
            if (convertToTxtBtn && textToTxtInputArea && textToTxtModal) {
                convertToTxtBtn.addEventListener('click', () => {
                    const text = textToTxtInputArea.value.trim();
                    if (!text) {
                        showCustomConfirm("الرجاء إدخال أسماء الطلاب أولاً.", "تنبيه");
                        return;
                    }

                    // --- بداية الطريقة الجديدة باستخدام data: URL ---
                    const fileName = `student_names_${new Date().toISOString().slice(0,10)}.txt`;
                    const dataUrl = 'data:text/plain;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(text)));
                    
                    const linkElement = document.createElement('a');
                    linkElement.href = dataUrl;
                    linkElement.download = fileName;
                    
                    document.body.appendChild(linkElement);
                    linkElement.click();
                    document.body.removeChild(linkElement);
                    // --- نهاية الطريقة الجديدة ---
                });
            }
            
            function sortStudentsByName(azSortOrder) { 
                if (!currentGradeKey || !currentSection || !appData[currentGradeKey]?.[currentSection]) {
                     showCustomConfirm("لا يوجد بيانات لترتيبها أو لم يتم تحديد الشعبة.", "تنبيه");
                    return;
                }
                const currentStudents = appData[currentGradeKey][currentSection];
                if (currentStudents.length === 0) {
                    showCustomConfirm("لا يوجد طلاب لترتيبهم.", "تنبيه");
                    return;
                }

                currentStudents.sort((a, b) => {
                    const nameA = String(a.name || "").trim().toLowerCase(); 
                    const nameB = String(b.name || "").trim().toLowerCase();
                    if (nameA < nameB) return azSortOrder ? -1 : 1;
                    if (nameA > nameB) return azSortOrder ? 1 : -1;
                    return 0;
                });

                renderStudentsTable(); 
                saveAppData(); 
                showCustomConfirm(azSortOrder ? "تم ترتيب الطلاب أبجدياً (أ-ي)." : "تم ترتيب الطلاب أبجدياً (ي-أ).", "تم الترتيب");
            }

            if (sortAzBtn) {
                sortAzBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                     actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    sortStudentsByName(true); 
                });
            }

            if (sortZaBtn) {
                sortZaBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                     actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    sortStudentsByName(false); 
                });
            }
            
            if (deleteAllStudentsBtn) {
                deleteAllStudentsBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    const studentsToDelete = appData[currentGradeKey]?.[currentSection];
                    if (!studentsToDelete || studentsToDelete.length === 0) {
                        showCustomConfirm("لا يوجد طلاب لحذفهم في الشعبة الحالية.", "تنبيه");
                        return;
                    }
                    showCustomConfirm(
                        `هل أنت متأكد من نقل جميع الطلاب (${studentsToDelete.length} طالب) إلى المحذوفات؟`,
                        "تأكيد نقل جميع الطلاب",
                        () => {
                            // المرور على كل الطلاب ونقلهم للمحذوفات
                            studentsToDelete.forEach((student, index) => {
                                const binItem = {
                                    studentData: student,
                                    gradeKey: currentGradeKey,
                                    sectionName: currentSection,
                                    originalIndex: index,
                                    deletionTimestamp: Date.now()
                                };
                                if (!appData.studentRecycleBin) appData.studentRecycleBin = [];
                                appData.studentRecycleBin.push(binItem);
                            });

                            // الآن، قم بتفريغ القائمة الأصلية
                            appData[currentGradeKey][currentSection] = [];
                            saveAppData();
                            renderStudentsTable();
                            showCustomConfirm("تم نقل جميع الطلاب إلى المحذوفات بنجاح.", "تم النقل");
                        }
                    );
                });
            }

            function showCustomConfirm(message, title = "تأكيد", okCallback, cancelCallback = null) {
                customConfirmModalTitle.textContent = title;
                customConfirmModalMessage.textContent = message;
                customConfirmModal.classList.add('active');
                updateBodyScrollLock();

                currentConfirmOkCallback = okCallback;
                currentConfirmCancelCallback = cancelCallback;
            }
            function setRowFocus(rowToFocus) {
                const table = document.getElementById('studentsTable');
                // أولاً، نزيل التركيز عن أي صف آخر
                table.querySelectorAll('.is-focused').forEach(row => row.classList.remove('is-focused'));
                
                // ثم نطبق التركيز على الصف المطلوب
                table.classList.add('row-focused');
                rowToFocus.classList.add('is-focused');
            }

            function clearAllRowFocus() {
                const table = document.getElementById('studentsTable');
                table.classList.remove('row-focused');
                table.querySelectorAll('.is-focused').forEach(row => row.classList.remove('is-focused'));
            }
            function clearAllRowFocus() {
                const table = document.getElementById('studentsTable');
                table.classList.remove('row-focused');
                table.querySelectorAll('.is-focused').forEach(row => row.classList.remove('is-focused'));
            }

            /* >>> الدالة الجديدة هنا <<< */
            function updateGradeOptionsState() {
                const mainClassBtn = document.getElementById('go-to-main-class-btn');
                if (!mainClassBtn || !currentGradeKey) return;

                const sections = Object.keys(appData[currentGradeKey] || {});
                const customSections = sections.filter(name => name !== DEFAULT_SECTION_NAME);

                const shouldDisable = customSections.length > 0;

                mainClassBtn.disabled = shouldDisable;
                mainClassBtn.style.opacity = shouldDisable ? 0.5 : 1;
                mainClassBtn.style.cursor = shouldDisable ? 'not-allowed' : 'pointer';
            }
            function updateOralTestButtonState() {
                const oralTestBtn = document.getElementById('oralTestBtn');
                if (!oralTestBtn) return;
                
                const hasStudents = appData[currentGradeKey]?.[currentSection]?.length > 0;
                oralTestBtn.style.opacity = hasStudents ? '1' : '0.5';
                oralTestBtn.style.cursor = hasStudents ? 'pointer' : 'not-allowed';
                oralTestBtn.dataset.enabled = hasStudents;
            }


            function calculateOralTestRow(row) {
                const listeningInput = row.querySelector('.oral-listening');
                const speakingInput = row.querySelector('.oral-speaking');
                const readingInput = row.querySelector('.oral-reading');
                const writtenInput = row.querySelector('.oral-written');
                const oralTotalInput = row.querySelector('.oral-total');
                const finalTotalInput = row.querySelector('.final-total');

                // حساب مجموع الشفوي فقط إذا كانت كل حقوله ممتلئة
                if (listeningInput.value.trim() !== '' && speakingInput.value.trim() !== '' && readingInput.value.trim() !== '') {
                    const oralTotal = (parseFloat(listeningInput.value) || 0) + (parseFloat(speakingInput.value) || 0) + (parseFloat(readingInput.value) || 0);
                    oralTotalInput.value = oralTotal;
                } else {
                    oralTotalInput.value = '';
                }

                // حساب المجموع النهائي فقط إذا كانت الحقول المطلوبة ممتلئة
                if (oralTotalInput.value.trim() !== '' && writtenInput.value.trim() !== '') {
                    const finalTotal = (parseFloat(oralTotalInput.value) || 0) + (parseFloat(writtenInput.value) || 0);
                    finalTotalInput.value = finalTotal;
                } else {
                    finalTotalInput.value = '';
                }
                
                finalTotalInput.classList.remove('grade-fail', 'grade-excellent');
                const finalGrade = parseFloat(finalTotalInput.value);
                if (!isNaN(finalGrade)) {
                    if (finalGrade < 50) {
                        finalTotalInput.classList.add('grade-fail');
                    } else if (finalGrade >= 90) {
                        finalTotalInput.classList.add('grade-excellent');
                    }
                }
            }

            function renderOralTestTable() {
                const oralTable = document.getElementById('oralTestTable');
                const oralTableTitle = document.getElementById('oral-test-table-title');
                if (!oralTable || !oralTableTitle) return;

                const titleText = currentOralTestType === 'mid-year' ? 'قائمة امتحان الشفوي - نصف السنة' : 'قائمة امتحان الشفوي - آخر السنة';
                oralTableTitle.textContent = titleText;
                
                const students = appData[currentGradeKey]?.[currentSection] || [];
                const oralTestTypeDataKey = currentOralTestType === 'mid-year' ? 'oral_mid_year' : 'oral_end_year';

                const isIntermediateOrSecondary = currentEducationalStage === 'intermediate' || currentEducationalStage === 'secondary';
                const structure = {
                    oralHeader: "Oral Test " + (isIntermediateOrSecondary ? "30M" : "40M"),
                    listening: "Listening 10M",
                    speaking: isIntermediateOrSecondary ? "Speaking 10M" : "Speaking 20M",
                    reading: "Reading 10M",
                    oralTotal: "Total " + (isIntermediateOrSecondary ? "30M" : "40M"),
                    writtenHeader: "Written Test",
                    writtenTest: isIntermediateOrSecondary ? "MID-YEAR 70" : "MID-YEAR 60",
                    finalTotal: "Totally 100M",
                    maxListening: 10,
                    maxSpeaking: isIntermediateOrSecondary ? 10 : 20,
                    maxReading: 10,
                    maxWritten: isIntermediateOrSecondary ? 70 : 60,
                };

                const thead = `
                    <thead class="screen-header">
                        <tr>
                            <th rowspan="2" class="th-sticky th-student-name">
                                <div class="name-col-resize-controls">
                                    <button onclick="adjustStudentNameColumnWidth(true)">+</button>
                                    <button onclick="adjustStudentNameColumnWidth(false)">-</button>
                                </div>
                                <div class="student-name-header-text-container">اسم الطالب الثلاثي</div>
                            </th>
                            <th colspan="4">${structure.oralHeader}</th>
                            <th colspan="2">${structure.writtenHeader}</th>
                            <th rowspan="2" class="action-col" style="text-align: center;">حذف</th>
                        </tr>
                        <tr>
                            <th style="text-align: center;">${structure.listening}</th>
                            <th style="text-align: center;">${structure.speaking}</th>
                            <th style="text-align: center;">${structure.reading}</th>
                            <th style="text-align: center;">${structure.oralTotal}</th>
                            <th style="text-align: center;">${structure.writtenTest}</th>
                            <th style="text-align: center;">${structure.finalTotal}</th>
                        </tr>
                    </thead>
                `;
                
                let tbodyContent = '';
                students.forEach((student, index) => {
                    if (!student.oral_tests) student.oral_tests = {};
                    if (!student.oral_tests[oralTestTypeDataKey]) {
                        student.oral_tests[oralTestTypeDataKey] = { listening: '', speaking: '', reading: '', written: '' };
                    }
                    const oralData = student.oral_tests[oralTestTypeDataKey];

                    tbodyContent += `
                        <tr class="student-row" data-student-index="${index}">
                            <td class="td-sticky col-name">
                                <input type="text" value="${student.name}" class="student-name" readonly>
                            </td>
                            <td><input type="number" min="0" max="${structure.maxListening}" class="oral-listening grade-input" value="${oralData.listening || ''}"></td>
                            <td><input type="number" min="0" max="${structure.maxSpeaking}" class="oral-speaking grade-input" value="${oralData.speaking || ''}"></td>
                            <td><input type="number" min="0" max="${structure.maxReading}" class="oral-reading grade-input" value="${oralData.reading || ''}"></td>
                            <td><input type="number" readonly class="oral-total calculated-grade"></td>
                            <td><input type="number" min="0" max="${structure.maxWritten}" class="oral-written grade-input" value="${oralData.written || ''}"></td>
                            <td><input type="number" readonly class="final-total calculated-grade"></td>
                            <td class="action-col">
                                <button class="btn-clear-oral-row" title="حذف درجات الصف">&times;</button>
                            </td>
                        </tr>
                    `;
                });

                oralTable.innerHTML = thead + `<tbody>${tbodyContent}</tbody>`;

                // إعادة تفعيل مستمعي الأحداث مع منطق التصفير التلقائي
                oralTable.querySelectorAll('tbody tr').forEach(row => {
                    const studentIndex = row.dataset.studentIndex;
                    
                    const clearBtn = row.querySelector('.btn-clear-oral-row');
                    if(clearBtn) {
                        clearBtn.addEventListener('click', () => {
                            row.querySelectorAll('.grade-input').forEach(input => {
                                input.value = '';
                            });
                            calculateOralTestRow(row);
                            if(appData[currentGradeKey][currentSection][studentIndex].oral_tests) {
                               appData[currentGradeKey][currentSection][studentIndex].oral_tests[oralTestTypeDataKey] = { listening: '', speaking: '', reading: '', written: '' };
                            }
                            saveAppData();
                        });
                    }
                    
                    row.querySelectorAll('.grade-input').forEach(input => {
                        input.addEventListener('input', () => {
                            let value = parseFloat(input.value);
                            const max = parseFloat(input.max);
                            
                            // --- بداية منطق التصفير الجديد ---
                            if (!isNaN(value) && value > max) {
                                input.value = '0'; // تصفير القيمة إذا كانت أكبر من الحد الأقصى
                                value = 0; // تحديث القيمة للمتابعة
                            }
                            // --- نهاية منطق التصفير الجديد ---

                            const field = input.classList.contains('oral-listening') ? 'listening' :
                                          input.classList.contains('oral-speaking') ? 'speaking' :
                                          input.classList.contains('oral-reading') ? 'reading' : 'written';
                            
                            if(appData[currentGradeKey]?.[currentSection]?.[studentIndex]?.oral_tests) {
                                appData[currentGradeKey][currentSection][studentIndex].oral_tests[oralTestTypeDataKey][field] = input.value;
                            }
                            calculateOralTestRow(row);
                            saveAppData();
                        });
                    });
                    calculateOralTestRow(row);
                });
            }

            if (customConfirmModalOk) {
                customConfirmModalOk.addEventListener('click', () => {
                    if (currentConfirmOkCallback) currentConfirmOkCallback();
                    customConfirmModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }
            if (customConfirmModalCancel) {
                customConfirmModalCancel.addEventListener('click', () => {
                    if (currentConfirmCancelCallback) currentConfirmCancelCallback();
                    customConfirmModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }

            function generateTableCanvas(callback, usePrintHeader = false) {
                const tableContainer = document.querySelector('.table-responsive');
                if (!tableContainer || !studentsTable) { 
                    console.error("Table container or studentsTable not found for canvas generation.");
                    if (callback) callback(null); 
                    return;
                }

                const screenHeader = studentsTable.querySelector('thead.screen-header');
                const printHeader = studentsTable.querySelector('thead.print-header'); 
                
                if (!screenHeader || !printHeader) {
                     console.error("Screen or Print header not found for canvas generation.");
                     if (callback) callback(null);
                     return;
                }

                const originalScreenDisplay = screenHeader.style.display;
                const originalPrintDisplay = printHeader.style.display;

                screenHeader.style.display = usePrintHeader ? 'none' : 'table-header-group';
                printHeader.style.display = usePrintHeader ? 'table-header-group' : 'none';

                const thNoColScreen = screenHeader.querySelector('.th-no-col');
                const originalThNoColDisplay = thNoColScreen ? thNoColScreen.style.display : '';
                if (thNoColScreen) thNoColScreen.style.display = 'table-cell';

                document.querySelectorAll('#studentsTable tbody .col-no-cell').forEach(cell => {
                    cell.style.display = 'table-cell'; 
                });


                html2canvas(tableContainer, { 
                    scale: 2, useCORS: true, allowTaint: true, backgroundColor: getComputedStyle(bodyElement).getPropertyValue('--container-bg').trim(), 
                    width: tableContainer.scrollWidth, height: tableContainer.scrollHeight,
                    windowWidth: tableContainer.scrollWidth, windowHeight: tableContainer.scrollHeight,
                    onclone: (docClone) => {
                        const clonedTable = docClone.getElementById('studentsTable');
                        if (!clonedTable) return;
                        
                        if (bodyElement.classList.contains('dark-mode')) {
                            docClone.body.classList.add('dark-mode');
                        }


                        const isElem = isElementaryStage(currentGradeKey);
                        clonedTable.querySelectorAll('.elementary-only-cell').forEach(cell => {
                            cell.style.display = isElem ? '' : 'none';
                        });
                        
                        clonedTable.querySelectorAll('.action-col, .name-col-resize-controls').forEach(el => {
                            el.style.display = 'none'; 
                        });
                        
                        const clonedScreenHeader = clonedTable.querySelector('thead.screen-header');
                        const clonedPrintHeader = clonedTable.querySelector('thead.print-header');

                        if(clonedScreenHeader) {
                            const clonedThNoCol = clonedScreenHeader.querySelector('.th-no-col');
                            if(clonedThNoCol) clonedThNoCol.style.display = 'table-cell';
                            clonedScreenHeader.style.display = usePrintHeader ? 'none' : 'table-header-group';
                        }
                        if(clonedPrintHeader) {
                             const clonedThNoColPrint = clonedPrintHeader.querySelector('.col-no'); 
                             if(clonedThNoColPrint) clonedThNoColPrint.style.display = 'table-cell';
                             clonedPrintHeader.style.display = usePrintHeader ? 'table-header-group' : 'none';
                        }
                        
                        clonedTable.querySelectorAll('tbody .col-no-cell').forEach(cell => {
                             cell.style.display = 'table-cell';
                        });


                        clonedTable.querySelectorAll('input').forEach(input => {
                            const span = docClone.createElement('span');
                            span.textContent = input.value;
                            span.className = input.className + ' canvas-span'; 
                            span.classList.remove('grade-input', 'student-name');
                            
                            const inputStyles = window.getComputedStyle(input);
                            span.style.backgroundColor = inputStyles.backgroundColor;
                            span.style.color = inputStyles.color;
                            span.style.fontWeight = inputStyles.fontWeight;
                            span.style.textAlign = inputStyles.textAlign || 'center';
                            span.style.padding = inputStyles.padding;
                            span.style.border = inputStyles.border; 
                            span.style.borderRadius = inputStyles.borderRadius;
                            span.style.display = 'flex';
                            span.style.alignItems = 'center';
                            span.style.justifyContent = 'center';
                            span.style.width = input.offsetWidth + 'px'; 
                            span.style.height = input.offsetHeight + 'px'; 

                            if (input.parentNode) input.parentNode.replaceChild(span, input);
                        });
                    }
                }).then(canvas => {
                    screenHeader.style.display = originalScreenDisplay;
                    printHeader.style.display = originalPrintDisplay;
                    if(thNoColScreen) thNoColScreen.style.display = originalThNoColDisplay; 
                     document.querySelectorAll('#studentsTable tbody .col-no-cell').forEach(cell => {
                        cell.style.display = ''; 
                    });
                    if (callback) callback(canvas); 
                }).catch(err => {
                    console.error("Canvas generation failed:", err);
                    showCustomConfirm("فشل في إنشاء الصورة/PDF. يرجى المحاولة مرة أخرى.", "خطأ");
                    screenHeader.style.display = originalScreenDisplay;
                    printHeader.style.display = originalPrintDisplay;
                    if(thNoColScreen) thNoColScreen.style.display = originalThNoColDisplay;
                    document.querySelectorAll('#studentsTable tbody .col-no-cell').forEach(cell => {
                        cell.style.display = ''; 
                    });
                    if (callback) callback(null); 
                });
            }

            previewImageBtn.addEventListener('click', () => {
                saveCurrentSectionData();
                actionsDropdownContent.classList.remove('active');
                actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                generateTableCanvas((canvas) => {
                    if (canvas) {
                        previewImage.src = canvas.toDataURL('image/png');
                        imagePreviewModal.classList.add('active'); 
                        updateBodyScrollLock();
                    } else {
                        showCustomConfirm("فشل في معاينة الصورة.", "خطأ");
                    }
                }, false); 
            });

            closeImagePreview.addEventListener('click', () => {
                imagePreviewModal.classList.remove('active');
                updateBodyScrollLock();
            });
            
            saveImageBtn.addEventListener('click', () => {
                if (!previewImage.src || previewImage.src === document.location.href) return; 
                const link = document.createElement('a');
                link.href = previewImage.src;
                link.download = `جدول_درجات_${currentGradeText.replace(/[ \/]/g, '_')}_${currentSection.replace(/[ \/]/g, '_')}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });

            function populateAnalyticsSelector() {
                if (!analyticsColumnSelector) return;
                analyticsColumnSelector.innerHTML = '';
                const isElem = isElementaryStage(currentGradeKey);

                for (const key in analyticsColumnMap) {
                    if (Object.hasOwnProperty.call(analyticsColumnMap, key)) {
                        if (key === 's1m3' && !isElem) {
                            continue; // Skip 3rd month if not elementary
                        }
                        const option = document.createElement('option');
                        option.value = key;
                        option.textContent = analyticsColumnMap[key];
                        analyticsColumnSelector.appendChild(option);
                    }
                }
                analyticsColumnSelector.value = 'overallfinal';
            }

            if (showAnalyticsBtn) {
                showAnalyticsBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    
                    if (!currentGradeKey || !currentSection || !appData[currentGradeKey]?.[currentSection]) {
                        showCustomConfirm("يرجى تحديد شعبة تحتوي على بيانات لعرض التحليلات.", "تنبيه");
                        return;
                    }
                    const students = appData[currentGradeKey][currentSection];
                    
                    populateAnalyticsSelector();
                    calculateAndDisplayAnalytics(students, analyticsColumnSelector.value); 
                    populateStudentSelectorForChart(students);
                    analyticsModal.classList.add('active');
                    updateBodyScrollLock();
                });
            }

            if(analyticsColumnSelector) {
                analyticsColumnSelector.addEventListener('change', (e) => {
                    const selectedGradeKey = e.target.value;
                    const students = appData[currentGradeKey]?.[currentSection] || [];
                    calculateAndDisplayAnalytics(students, selectedGradeKey);
                });
            }

            if (closeAnalyticsModal) {
                closeAnalyticsModal.addEventListener('click', () => {
                     analyticsModal.classList.remove('active');
                     updateBodyScrollLock();
                });
            }

            function calculateAndDisplayAnalytics(students, gradeKey) { 
                let passedCount = 0;
                let failedCount = 0;
                let highestGrade = -1;
                let lowestGrade = 101;
                const gradesForAnalysis = [];
                const studentsNeedingSupport = [];
                const successfulStudents = [];

                students.forEach(student => {
                    const gradeStr = student[gradeKey];
                    if (gradeStr !== null && gradeStr !== undefined && gradeStr.trim() !== '' && !isNaN(gradeStr)) {
                        const grade = parseFloat(gradeStr);
                        gradesForAnalysis.push(grade);
                        if (grade >= 50) {
                            passedCount++;
                            successfulStudents.push({ name: student.name || 'طالب غير مسمى', grade: grade });
                        } else {
                            failedCount++;
                            // Consider any failing grade as needing support
                            studentsNeedingSupport.push({ name: student.name || 'طالب غير مسمى', grade: grade });
                        }
                        if (grade > highestGrade) highestGrade = grade;
                        if (grade < lowestGrade) lowestGrade = grade;
                    }
                });

                // --- Standard Deviation Calculation ---
                const totalGrades = gradesForAnalysis.length;
                let mean = 0;
                let stdDev = 0;
                if (totalGrades > 0) {
                    mean = gradesForAnalysis.reduce((a, b) => a + b, 0) / totalGrades;
                }
                if (totalGrades > 1) { // Std dev is not meaningful for 0 or 1 items
                    const variance = gradesForAnalysis.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / totalGrades;
                    stdDev = Math.sqrt(variance);
                }

                // Update the Standard Deviation stat card
                const stdDevStatEl = document.getElementById('stdDevStat');
                const stdDevInterpretationEl = document.getElementById('stdDevInterpretation');
                if (stdDevStatEl && stdDevInterpretationEl) {
                    stdDevStatEl.textContent = totalGrades > 1 ? stdDev.toFixed(2) : '-';
                    if (totalGrades <= 1) {
                        stdDevInterpretationEl.textContent = 'لا يمكن حساب التشتت';
                        stdDevStatEl.style.color = 'var(--text-color)';
                    } else if (stdDev < 10) {
                        stdDevInterpretationEl.textContent = 'تشتت منخفض: تقارب في مستوى الطلاب';
                        stdDevStatEl.style.color = 'var(--success-color)';
                    } else if (stdDev < 20) {
                        stdDevInterpretationEl.textContent = 'تشتت متوسط: تباين طبيعي في المستويات';
                        stdDevStatEl.style.color = 'var(--warning-color)';
                    } else {
                        stdDevInterpretationEl.textContent = 'تشتت عالٍ: تباين كبير في أداء الطلاب';
                        stdDevStatEl.style.color = 'var(--danger-color)';
                    }
                }

                // Update Needs Support and Top Students lists
                needsSupportList.innerHTML = '';
                if (studentsNeedingSupport.length > 0) {
                    studentsNeedingSupport.sort((a,b) => a.grade - b.grade); // Sort from lowest to highest
                    studentsNeedingSupport.forEach(s => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${s.name}</span><span class="grade grade-fail">${s.grade}</span>`;
                        needsSupportList.appendChild(li);
                    });
                } else {
                    needsSupportList.innerHTML = '<li class="no-students-msg">لا يوجد طلاب بحاجة لدعم.</li>';
                }

                topStudentsList.innerHTML = '';
                if (successfulStudents.length > 0) {
                    successfulStudents.sort((a, b) => b.grade - a.grade); // Sort from highest to lowest
                    const topPerformers = successfulStudents.slice(0, 3); 
                    topPerformers.forEach(s => {
                        const li = document.createElement('li');
                        const gradeClass = s.grade >= 90 ? 'grade-excellent' : '';
                        li.innerHTML = `<span>${s.name}</span><span class="grade ${gradeClass}">${s.grade}</span>`;
                        topStudentsList.appendChild(li);
                    });
                } else {
                    topStudentsList.innerHTML = '<li class="no-students-msg">لا يوجد طلاب ناجحون.</li>';
                }

                // Update general stats
                totalStudentsStat.textContent = students.length;
                passedStudentsStat.textContent = passedCount;
                failedStudentsStat.textContent = failedCount;
                highestGradeStat.textContent = highestGrade === -1 ? '-' : highestGrade;
                lowestGradeStat.textContent = lowestGrade === 101 ? '-' : lowestGrade;

                const totalStudentsWithGrades = passedCount + failedCount;
                let successPercentage = 0;
                if (totalStudentsWithGrades > 0) {
                   successPercentage = (passedCount / totalStudentsWithGrades) * 100;
                }
                successPercentageStat.textContent = totalStudentsWithGrades > 0 ? `${successPercentage.toFixed(1)}%` : '-';

                // Update Grade Distribution Chart
                const gradeRanges = {
                    '0-49 (راسب)': 0, '50-59 (مقبول)': 0, '60-69 (متوسط)': 0,
                    '70-79 (جيد)': 0, '80-89 (جيد جداً)': 0, '90-100 (ممتاز)': 0
                };

                gradesForAnalysis.forEach(grade => {
                    if (grade >= 90) gradeRanges['90-100 (ممتاز)']++;
                    else if (grade >= 80) gradeRanges['80-89 (جيد جداً)']++;
                    else if (grade >= 70) gradeRanges['70-79 (جيد)']++;
                    else if (grade >= 60) gradeRanges['60-69 (متوسط)']++;
                    else if (grade >= 50) gradeRanges['50-59 (مقبول)']++;
                    else gradeRanges['0-49 (راسب)']++;
                });

                if (gradeChartInstance) {
                    gradeChartInstance.destroy();
                }

                const isDark = bodyElement.classList.contains('dark-mode');
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const ticksColor = isDark ? '#e0e0e0' : '#666';
                const chartTitleText = `توزيع الدرجات (${analyticsColumnMap[gradeKey] || ''})`;
                
                const distributionChartTitleEl = analyticsModal.querySelector('#gradeDistributionChartContainer').previousElementSibling;
                if(distributionChartTitleEl) distributionChartTitleEl.textContent = chartTitleText;

                gradeChartInstance = new Chart(gradeDistributionChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(gradeRanges),
                        datasets: [{
                            label: 'عدد الطلاب',
                            data: Object.values(gradeRanges),
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.7)', 
                                'rgba(255, 193, 7, 0.7)', 
                                'rgba(23, 162, 184, 0.7)', 
                                'rgba(0, 86, 179, 0.7)',  
                                'rgba(40, 167, 69, 0.7)', 
                                'rgba(111, 66, 193, 0.7)'
                            ],
                            borderColor: [
                                'rgb(220, 53, 69)',
                                'rgb(255, 193, 7)',
                                'rgb(23, 162, 184)',
                                'rgb(0, 86, 179)',
                                'rgb(40, 167, 69)',
                                'rgb(111, 66, 193)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1, color: ticksColor }, grid: { color: gridColor } },
                            x: { ticks: { color: ticksColor }, grid: { color: gridColor } }
                        },
                        plugins: {
                            legend: { display: false },
                            title: { display: false }
                        }
                    }
                });
            }
            
            function populateStudentSelectorForChart(students) {
                selectStudentForChart.innerHTML = '<option value="">-- اختر طالباً --</option>';
                students.forEach((student, index) => {
                    const studentName = student.name && student.name.trim() !== "" ? student.name : `طالب #${index + 1}`;
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = studentName;
                    selectStudentForChart.appendChild(option);
                });
                
                const placeholder = document.getElementById('individualStudentChartPlaceholder');
                const canvas = document.getElementById('individualStudentGradeChart');

                if (canvas) canvas.style.display = 'none';
                if (placeholder) placeholder.style.display = 'flex';

                if (individualStudentChartInstance) {
                    individualStudentChartInstance.destroy();
                    individualStudentChartInstance = null;
                }
            }
            
            selectStudentForChart.addEventListener('change', function() {
                const selectedIndex = this.value;
                const placeholder = document.getElementById('individualStudentChartPlaceholder');
                const canvas = document.getElementById('individualStudentGradeChart');
                
                if (selectedIndex === "") {
                    if (individualStudentChartInstance) {
                        individualStudentChartInstance.destroy();
                        individualStudentChartInstance = null;
                    }
                    if (canvas) canvas.style.display = 'none';
                    if (placeholder) placeholder.style.display = 'flex';
                    return;
                }
                const students = appData[currentGradeKey]?.[currentSection] || [];
                const studentData = students[parseInt(selectedIndex, 10)];
                if (studentData) {
                    if (placeholder) placeholder.style.display = 'none';
                    if (canvas) canvas.style.display = 'block';
                    plotIndividualStudentChart(studentData);
                }
            });

            function plotIndividualStudentChart(student) {
                if (individualStudentChartInstance) {
                    individualStudentChartInstance.destroy();
                }
                const isElem = isElementaryStage(currentGradeKey);
                const labels = [
                    'شهر 1 ف1', 'شهر 2 ف1', 
                    ...(isElem ? ['شهر 3 ف1'] : []),
                    'منتصف العام', 
                    'شهر 1 ف2', 'شهر 2 ف2',
                    'المجهود السنوي',
                    'نهاية العام',
                    'المجموع النهائي'
                ];
                const dataPoints = [
                    parseFloat(student.s1m1) || null,
                    parseFloat(student.s1m2) || null,
                    ...(isElem ? [parseFloat(student.s1m3) || null] : []),
                    parseFloat(student.midyear) || null,
                    parseFloat(student.s2m1) || null,
                    parseFloat(student.s2m2) || null,
                    parseFloat(student.annualeffort) || null,
                    parseFloat(student.finalexam) || null,
                    parseFloat(student.overallfinal) || null
                ];

                const isDark = bodyElement.classList.contains('dark-mode');
                const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const ticksColor = isDark ? '#e0e0e0' : '#666';
                const titleColor = isDark ? '#f0f0f0' : '#333';
                const lineColor = isDark ? '#4dabf7' : '#0056b3'; 
                const pointColor = isDark ? '#fcc419' : '#ffc107'; 

                individualStudentChartInstance = new Chart(individualStudentGradeChartCanvas, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `درجات الطالب: ${student.name}`,
                            data: dataPoints,
                            borderColor: lineColor,
                            backgroundColor: lineColor.replace(')', ', 0.2)'), 
                            pointBackgroundColor: pointColor,
                            pointBorderColor: pointColor,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            tension: 0.1,
                            fill: true,
                            spanGaps: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100, 
                                ticks: { color: ticksColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: ticksColor },
                                grid: { display: false } 
                            }
                        },
                        plugins: {
                            legend: { display: false }, 
                            title: {
                                display: true,
                                text: `مستوى درجات الطالب: ${student.name}`,
                                color: titleColor,
                                font: { size: 14 }
                            }
                        }
                    }
                });
            }
            
            if (printAnalyticsBtn) {
                printAnalyticsBtn.addEventListener('click', () => {
                    const analyticsContentToPrint = analyticsModal.querySelector('.analytics-content-wrapper'); 
                    const originalTitle = analyticsModal.querySelector('.analytics-title').textContent;
                    
                    html2canvas(analyticsContentToPrint, { 
                        scale: 2, 
                        useCORS: true, 
                        backgroundColor: getComputedStyle(bodyElement).getPropertyValue('--container-bg').trim(),
                        onclone: (docClone) => {
                             if (bodyElement.classList.contains('dark-mode')) {
                                docClone.body.classList.add('dark-mode');
                            }
                            const studentSelectClone = docClone.getElementById('selectStudentForChart');
                            if (studentSelectClone && studentSelectClone.selectedIndex > 0) {
                                const selectedStudentName = studentSelectClone.options[studentSelectClone.selectedIndex].text;
                                const nameSpan = docClone.createElement('p');
                                nameSpan.textContent = `الطالب المحدد: ${selectedStudentName}`;
                                nameSpan.style.textAlign = 'center';
                                nameSpan.style.fontWeight = 'bold';
                                nameSpan.style.color = getComputedStyle(docClone.body).getPropertyValue('--text-color').trim();
                                studentSelectClone.parentNode.insertBefore(nameSpan, studentSelectClone);
                                studentSelectClone.style.display = 'none';
                            } else if (studentSelectClone) {
                                studentSelectClone.style.display = 'none'; 
                                docClone.querySelector('label[for="selectStudentForChart"]').style.display = 'none';
                            }
                        }
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF('p', 'mm', 'a4');
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = pdf.internal.pageSize.getHeight();
                        const imgProps= pdf.getImageProperties(imgData);
                        const imgHeight = (imgProps.height * pdfWidth) / imgProps.width;
                        let heightLeft = imgHeight;
                        let position = 10; 

                        pdf.setFont('Tajawal', 'normal'); 
                        pdf.text(originalTitle, pdfWidth / 2, position, { align: 'center' });
                        position += 10;
                        
                        const pageContentHeight = pdfHeight - position - 10; 

                        if (imgHeight <= pageContentHeight ) { 
                             pdf.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, imgHeight);
                        } else { 
                             pdf.addImage(imgData, 'PNG', 10, position, pdfWidth - 20, pageContentHeight );
                             heightLeft -= pageContentHeight;
                             let printedHeight = pageContentHeight;

                             while (heightLeft > 0) {
                                 pdf.addPage();
                                 let currentChunkHeight = Math.min(heightLeft, pdfHeight - 20); 
                                 let sourceY = (printedHeight / imgHeight) * imgProps.height;
                                 let sourceChunkHeight = (currentChunkHeight / imgHeight) * imgProps.height;

                                 const tempCanvas = document.createElement('canvas');
                                 tempCanvas.width = imgProps.width;
                                 tempCanvas.height = sourceChunkHeight;
                                 const tempCtx = tempCanvas.getContext('2d');
                                 tempCtx.drawImage(canvas, 0, sourceY, imgProps.width, sourceChunkHeight, 0, 0, imgProps.width, sourceChunkHeight);
                                 const chunkImgData = tempCanvas.toDataURL('image/png');
                                 
                                 pdf.addImage(chunkImgData, 'PNG', 10, 10, pdfWidth - 20, currentChunkHeight);
                                 heightLeft -= currentChunkHeight;
                                 printedHeight += currentChunkHeight;
                             }
                        }
                        pdf.save(`تحليلات_${currentGradeText.replace(/[ \/]/g, '_')}_${currentSection.replace(/[ \/]/g, '_')}.pdf`);
                    }).catch(err => {
                        console.error("Error generating analytics PDF:", err);
                        showCustomConfirm("فشل في طباعة التقرير.", "خطأ");
                    });
                });
            }

            function exportData(isFullExport) {
                try {
                    const dataToExport = isFullExport ? appData : { [currentGradeKey]: { [currentSection]: appData[currentGradeKey]?.[currentSection] || [] } };
                    const dataStr = JSON.stringify(dataToExport, null, 2);
                    const timestamp = new Date().toISOString().slice(0, 10);
                    const fileName = isFullExport ? `backup_all_${timestamp}.json` : `backup_${currentGradeKey}_${currentSection.replace(/[ \/]/g, '_')}_${timestamp}.json`;

                    // --- بداية الطريقة الجديدة باستخدام data: URL ---

                    // 1. إنشاء رابط بيانات base64
                    // btoa() تقوم بتحويل النص إلى صيغة base64
                    // unescape(encodeURIComponent()) تضمن أن الحروف العربية والرموز تعمل بشكل صحيح
                    const dataUrl = 'data:application/json;charset=utf-8;base64,' + btoa(unescape(encodeURIComponent(dataStr)));
                    
                    // 2. إنشاء عنصر رابط وهمي في الذاكرة
                    const linkElement = document.createElement('a');
                    linkElement.href = dataUrl;
                    linkElement.download = fileName;

                    // 3. محاكاة النقر على الرابط لبدء التنزيل
                    document.body.appendChild(linkElement); // يجب إضافته للصفحة ليعمل في كل البيئات
                    linkElement.click();
                    document.body.removeChild(linkElement); // حذف الرابط بعد بدء التنزيل

                    // --- نهاية الطريقة الجديدة ---

                    exportModal.classList.remove('active');
                    updateBodyScrollLock();
                    showSuccessIndicator('✓', 'var(--success-color)');

                } catch (error) {
                    console.error("Export failed with new method:", error);
                    showCustomConfirm("فشل تصدير البيانات. حدث خطأ غير متوقع.", "خطأ في التصدير");
                }
            }

            if (exportJsonBtn) {
                exportJsonBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    exportModal.classList.add('active');
                    updateBodyScrollLock();
                });
            }
            if (closeExportModalBtn) {
                closeExportModalBtn.addEventListener('click', () => {
                    exportModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }
            if (exportCurrentBtn) exportCurrentBtn.addEventListener('click', () => exportData(false));
            if (exportAllBtn) exportAllBtn.addEventListener('click', () => exportData(true));
            

            if (importJsonBtn && jsonFileInput) {
                importJsonBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    showCustomConfirm(
                        'يرجى استيراد البيانات من هاتفك.',
                        'تحذير: الكتابة فوق البيانات',
                        () => {
                            jsonFileInput.click();
                        }
                    );
                });

                jsonFileInput.addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (typeof importedData !== 'object' || importedData === null) {
                                    throw new Error("Invalid data format");
                                }
                                appData = importedData;
                                saveAppData();
                                showCustomConfirm('تم استيراد البيانات بنجاح. سيتم الآن تحديث التطبيق.', 'نجاح', () => {
                                    navigateToPage('page-main-selection'); 
                                });
                            } catch (error) {
                                showCustomConfirm(`فشل استيراد الملف. يرجى التأكد من أن الملف هو ملف JSON صالح. الخطأ: ${error.message}`, 'خطأ في الاستيراد');
                            }
                        };
                        reader.onerror = () => showCustomConfirm("فشل في قراءة الملف.", "خطأ");
                        reader.readAsText(file);
                        jsonFileInput.value = ''; 
                    }
                });
            }
            if(setPasswordLink) {
                setPasswordLink.addEventListener('click', () => {
                    developerInfoModal.classList.remove('active');
                    developerInfoHamburger.classList.remove('active');
                    setPasswordModal.classList.add('active');
                    passwordInput.value = '';
                    confirmPasswordInput.value = '';
                    handlePasswordCheck();
                    updateBodyScrollLock();
                });
            }

            if(cancelSetPasswordBtn) {
                cancelSetPasswordBtn.addEventListener('click', () => {
                    setPasswordModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }
            
            if(passwordInput) {
                passwordInput.addEventListener('input', handlePasswordCheck);
            }

            if(savePasswordBtn) {
                savePasswordBtn.addEventListener('click', () => {
                    const password = passwordInput.value;
                    const confirmPassword = confirmPasswordInput.value;
                    const strength = checkPasswordStrength(password);

                    if (password !== confirmPassword) {
                        showCustomConfirm("كلمتا المرور غير متطابقتين!", "خطأ");
                        return;
                    }

                    if (password.length > 0 && strength === 'weak') {
                        showCustomConfirm("لا يمكن استخدام كلمة مرور ضعيفة.", "خطأ");
                        return;
                    }
                    
                    if (password.length > 0) {
                        localStorage.setItem(PASSWORD_KEY, password);
                        showCustomConfirm("تم حفظ كلمة المرور بنجاح.", "نجاح");
                    } else {
                        localStorage.removeItem(PASSWORD_KEY);
                        showCustomConfirm("تم إزالة كلمة المرور بنجاح.", "نجاح");
                    }
                    
                    setPasswordModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }

            if (developerInfoHamburger) {
                developerInfoHamburger.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    developerInfoHamburger.classList.toggle('active');
                    developerInfoModal.classList.toggle('active');
                    updateBodyScrollLock();
                });
            }
            if (closeDeveloperInfoModalBtn) {
                closeDeveloperInfoModalBtn.addEventListener('click', () => {
                    developerInfoModal.classList.remove('active');
                    developerInfoHamburger.classList.remove('active');
                    updateBodyScrollLock();
                });
            }
            
            if(openRecycleBinBtn) {
                openRecycleBinBtn.addEventListener('click', () => {
                    openRecycleBin();
                });
            }
            if(closeRecycleBinModal) {
                closeRecycleBinModal.addEventListener('click', () => {
                    recycleBinModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }

            function showSuccessIndicator(icon = '✓', color = 'var(--success-color)') {
                if (!successIndicator) return;
                const checkmarkSpan = successIndicator.querySelector('.success-indicator-checkmark');
                checkmarkSpan.textContent = icon;
                checkmarkSpan.style.color = color;

                successIndicator.classList.add('visible');
                
                setTimeout(() => {
                    successIndicator.classList.remove('visible');
                }, 1200);
            }

            function openRecycleBin() {
                recycleBinList.innerHTML = '';
                const binItems = Object.entries(appData.recycleBin || {});
                
                const selectAllContainer = document.getElementById('bin-select-all-container');
                const binActionsFooter = document.getElementById('bin-actions-footer');

                if (binItems.length === 0) {
                    recycleBinList.innerHTML = '<p style="text-align:center; color: var(--secondary-color);">سلة المهملات فارغة.</p>';
                    if (selectAllContainer) selectAllContainer.style.display = 'none';
                    if (binActionsFooter) binActionsFooter.style.display = 'none';
                } else {
                    if (selectAllContainer) selectAllContainer.style.display = 'block';
                    if (binActionsFooter) binActionsFooter.style.display = 'flex';
                    
                    document.getElementById('bin-select-all-checkbox').checked = false;

                    binItems.forEach(([uniqueId, itemData]) => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'recycle-bin-item';
                        
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.id = uniqueId;
                        checkbox.onchange = updateRecycleBinBulkActionsState;
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'recycle-bin-item-name';
                        nameSpan.textContent = `${itemData.gradeText} - ${itemData.sectionName}`;
                        
                        label.appendChild(nameSpan);
                        label.appendChild(checkbox);
                        itemDiv.appendChild(label);
                        recycleBinList.appendChild(itemDiv);
                    });
                    updateRecycleBinBulkActionsState();
                }

                recycleBinModal.classList.add('active');
                updateBodyScrollLock();
            }

            function updateRecycleBinBulkActionsState() {
                const allCheckboxes = recycleBinList.querySelectorAll('input[type="checkbox"]');
                const checkedCheckboxes = recycleBinList.querySelectorAll('input[type="checkbox"]:checked');
                const hasSelection = checkedCheckboxes.length > 0;

                document.getElementById('restoreSelectedSectionsBtn').disabled = !hasSelection;
                document.getElementById('deleteSelectedSectionsBtn').disabled = !hasSelection;
                
                document.getElementById('bin-select-all-checkbox').checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
            }
            // === دوال سلة محذوفات الطلاب الجديدة والمطورة ===
            const studentRecycleBinModal = document.getElementById('studentRecycleBinModal');
            const closeStudentRecycleBinModalBtn = document.getElementById('closeStudentRecycleBinModal');
            const openStudentRecycleBinBtn = document.getElementById('openStudentRecycleBinBtn');
            const studentRecycleBinList = document.getElementById('student-recycle-bin-list');
            const selectAllContainer = document.getElementById('student-bin-select-all-container');
            const selectAllCheckbox = document.getElementById('student-bin-select-all-checkbox');
            const binActionsFooter = document.getElementById('student-bin-actions-footer');
            const restoreSelectedBtn = document.getElementById('restoreSelectedStudentsBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedStudentsBtn');

            function updateBulkActionButtonsState() {
                const checkedCheckboxes = studentRecycleBinList.querySelectorAll('input[type="checkbox"]:checked');
                const hasSelection = checkedCheckboxes.length > 0;
                restoreSelectedBtn.disabled = !hasSelection;
                deleteSelectedBtn.disabled = !hasSelection;
            }

            function openStudentRecycleBin() {
                studentRecycleBinList.innerHTML = '';
                const allBinItems = appData.studentRecycleBin || [];
                const binItems = allBinItems.filter(item => item.gradeKey === currentGradeKey);

                if (binItems.length === 0) {
                    studentRecycleBinList.innerHTML = '<p style="text-align:center; color: var(--secondary-color);">لا يوجد طلاب محذوفون لهذا الصف.</p>';
                    selectAllContainer.style.display = 'none';
                    binActionsFooter.style.display = 'none';
                } else {
                    selectAllContainer.style.display = 'block';
                    binActionsFooter.style.display = 'flex';
                    selectAllCheckbox.checked = false;

                    binItems.forEach(item => {
                        const originalIndex = allBinItems.findIndex(globalItem => globalItem === item);
                        if (originalIndex === -1) return;

                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'student-recycle-bin-item';
                        
                        const label = document.createElement('label');
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.dataset.originalIndex = originalIndex;
                        checkbox.onchange = () => {
                            const totalCheckboxes = studentRecycleBinList.querySelectorAll('input[type="checkbox"]').length;
                            const checkedCheckboxes = studentRecycleBinList.querySelectorAll('input[type="checkbox"]:checked').length;
                            selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
                            updateBulkActionButtonsState();
                        };
                        
                        const nameSpan = document.createElement('span');
                        nameSpan.className = 'student-recycle-bin-item-name';
                        const studentName = item.studentData.name || 'طالب بلا اسم';
                        
                        // --- التعديل الأول: حذف اسم الشعبة ---
                        nameSpan.innerHTML = `${studentName}`; 
                        
                        // --- التعديل الثاني: تغيير ترتيب الإضافة ---
                        label.appendChild(nameSpan);   // إضافة الاسم أولاً
                        label.appendChild(checkbox); // إضافة مربع التحديد ثانياً
                        // ------------------------------------

                        itemDiv.appendChild(label);
                        studentRecycleBinList.appendChild(itemDiv);
                    });
                    updateBulkActionButtonsState();
                }
                studentRecycleBinModal.classList.add('active');
                updateBodyScrollLock();
            }

            function restoreSelectedStudents() {
                const selectedIndexes = Array.from(studentRecycleBinList.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.dataset.originalIndex, 10))
                    .sort((a, b) => b - a); // الترتيب التنازلي لتجنب مشاكل حذف العناصر

                if (selectedIndexes.length === 0) return;

                selectedIndexes.forEach(binIndex => {
                    const itemToRestore = appData.studentRecycleBin[binIndex];
                    if (itemToRestore) {
                        const { studentData, gradeKey, sectionName } = itemToRestore;
                        if (!appData[gradeKey]) appData[gradeKey] = {};
                        if (!appData[gradeKey][sectionName]) appData[gradeKey][sectionName] = [];
                        appData[gradeKey][sectionName].push(studentData);
                        appData.studentRecycleBin.splice(binIndex, 1);
                    }
                });
                
                saveAppData();
                renderStudentsTable();
                openStudentRecycleBin();
                showSuccessIndicator('✓', 'var(--success-color)');
            }

            function permanentlyDeleteSelectedStudents() {
                const selectedIndexes = Array.from(studentRecycleBinList.querySelectorAll('input[type="checkbox"]:checked'))
                    .map(cb => parseInt(cb.dataset.originalIndex, 10));

                if (selectedIndexes.length === 0) return;

                studentRecycleBinModal.classList.remove('active');

                showCustomConfirm(`هل أنت متأكد من الحذف النهائي لـ ${selectedIndexes.length} طالب؟ لا يمكن التراجع عن هذا الإجراء.`, 'تأكيد الحذف النهائي',
                () => {
                    selectedIndexes.sort((a, b) => b - a).forEach(binIndex => {
                        appData.studentRecycleBin.splice(binIndex, 1);
                    });
                    saveAppData();
                    showSuccessIndicator('🗑️', 'var(--danger-color)');
                    updateBodyScrollLock();
                },
                () => {
                    studentRecycleBinModal.classList.add('active');
                    updateBodyScrollLock();
                });
            }

            if(openStudentRecycleBinBtn) {
                openStudentRecycleBinBtn.addEventListener('click', () => {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                    openStudentRecycleBin();
                });
            }

            if(closeStudentRecycleBinModalBtn) {
                closeStudentRecycleBinModalBtn.addEventListener('click', () => {
                    studentRecycleBinModal.classList.remove('active');
                    updateBodyScrollLock();
                });
            }

            if(selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', () => {
                    studentRecycleBinList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                        checkbox.checked = selectAllCheckbox.checked;
                    });
                    updateBulkActionButtonsState();
                });
            }
            
            if(restoreSelectedBtn) restoreSelectedBtn.addEventListener('click', restoreSelectedStudents);
            if(deleteSelectedBtn) deleteSelectedBtn.addEventListener('click', permanentlyDeleteSelectedStudents);

            if(searchInput) {
                searchInput.addEventListener('input', filterTable);
            }

            document.querySelectorAll('.sortable-header').forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sortKey;
                    sortTableByColumn(sortKey, header);
                });
            });

            function filterTable() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const rows = studentsTableBody.querySelectorAll('tr.student-row');
                rows.forEach(row => {
                    const studentName = row.querySelector('.student-name').value.toLowerCase();
                    if (studentName.includes(searchTerm)) {
                        row.style.display = "";
                    } else {
                        row.style.display = "none";
                    }
                });
            }
            
            function sortTableByColumn(sortKey, clickedHeader) {
                if (currentSortState.key === sortKey) {
                    currentSortState.direction = currentSortState.direction === 'desc' ? 'asc' : 'desc';
                } else {
                    currentSortState.key = sortKey;
                    currentSortState.direction = 'desc'; 
                }

                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.removeAttribute('data-sort-dir');
                });
                clickedHeader.setAttribute('data-sort-dir', currentSortState.direction);

                const rows = Array.from(studentsTableBody.querySelectorAll('tr.student-row'));
                const sortDirection = currentSortState.direction === 'desc' ? -1 : 1;
                
                rows.sort((rowA, rowB) => {
                    const valA = parseFloat(rowA.querySelector(`.${sortKey}`).value) || -1;
                    const valB = parseFloat(rowB.querySelector(`.${sortKey}`).value) || -1;
                    return (valA - valB) * sortDirection;
                });

                studentsTableBody.innerHTML = '';
                rows.forEach(row => studentsTableBody.appendChild(row));
                updateRowNumbers();
            }

            function resetTableSortAndFilter() {
                searchInput.value = '';
                filterTable();
                currentSortState = { key: null, direction: 'none' };
                document.querySelectorAll('.sortable-header').forEach(header => {
                    header.removeAttribute('data-sort-dir');
                });
            }

            document.addEventListener('click', (e) => {
                if (actionsDropdownContent?.classList.contains('active') && 
                    !actionsDropdownToggle?.contains(e.target) && !actionsDropdownContent.contains(e.target)) {
                    actionsDropdownContent.classList.remove('active');
                    actionsDropdownToggle?.querySelector('.dropdown-arrow').classList.remove('open');
                }
                if (addSectionOptionsDropdown?.style.display === 'block' &&
                    addSectionMainBtn && !addSectionMainBtn.contains(e.target) && 
                    !addSectionOptionsDropdown.contains(e.target)) {
                    addSectionOptionsDropdown.style.display = 'none';
                    updateBodyScrollLock();
                }
                if (developerInfoModal.classList.contains('active') && 
                    !developerInfoModal.querySelector('.developer-info-container').contains(e.target) && 
                    e.target !== developerInfoHamburger && !developerInfoHamburger.contains(e.target)) {
                    developerInfoModal.classList.remove('active');
                    developerInfoHamburger.classList.remove('active');
                    updateBodyScrollLock();
                }
            });
            document.addEventListener('click', (e) => {
                const table = document.getElementById('studentsTable');
                // إذا كان وضع التركيز فعالاً والنقرة كانت خارج الصف المحدد
                if (table && table.classList.contains('row-focused') && !e.target.closest('.student-row.is-focused')) {
                    clearAllRowFocus();
                }
            });
           document.getElementById('bin-select-all-checkbox')?.addEventListener('change', (e) => {
                recycleBinList.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = e.target.checked;
                });
                updateRecycleBinBulkActionsState();
            });

            document.getElementById('restoreSelectedSectionsBtn')?.addEventListener('click', () => {
                const selectedIds = Array.from(recycleBinList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;
                
                let restoredCount = 0;
                let conflictExists = false;
                selectedIds.forEach(id => {
                    const itemToRestore = appData.recycleBin[id];
                    if (itemToRestore) {
                        if (appData[itemToRestore.gradeKey] && appData[itemToRestore.gradeKey][itemToRestore.sectionName]) {
                            conflictExists = true;
                        } else {
                            if (!appData[itemToRestore.gradeKey]) appData[itemToRestore.gradeKey] = {};
                            appData[itemToRestore.gradeKey][itemToRestore.sectionName] = itemToRestore.students;
                            delete appData.recycleBin[id];
                            restoredCount++;
                        }
                    }
                });

                saveAppData();
                if (conflictExists) {
                    showCustomConfirm(`تم استعادة ${restoredCount} شعبة. بعض الشعب لم تتم استعادتها لوجود شعب أخرى بنفس الاسم.`, "اكتمل مع تحذير");
                }
                openRecycleBin(); // Refresh the list
            });

            document.getElementById('deleteSelectedSectionsBtn')?.addEventListener('click', () => {
                const selectedIds = Array.from(recycleBinList.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.dataset.id);
                if (selectedIds.length === 0) return;

                showCustomConfirm(`هل أنت متأكد من الحذف النهائي لـ ${selectedIds.length} شعبة؟ لا يمكن التراجع عن هذا الإجراء.`, "تأكيد الحذف النهائي", () => {
                    selectedIds.forEach(id => {
                        delete appData.recycleBin[id];
                    });
                    saveAppData();
                    openRecycleBin();
                });
            });
           
            /* >>> الصق الكود الجديد هنا <<< */
            const toggleFocusModeBtn = document.getElementById('toggleFocusModeBtn');
            if (toggleFocusModeBtn) {
                toggleFocusModeBtn.addEventListener('click', () => {
                    isFocusModeActive = !isFocusModeActive; // تبديل الحالة
                    toggleFocusModeBtn.classList.toggle('active', isFocusModeActive); // لإظهار/إخفاء علامة الصح

                    // إذا قمنا بإلغاء وضع التركيز، نزيل أي تحديد حالي
                    if (!isFocusModeActive) {
                        clearAllRowFocus();
                    }
                });
            }
            const oralTestBtn = document.getElementById('oralTestBtn');
            const oralTestTypeModal = document.getElementById('oralTestTypeModal');
            const closeOralTestTypeModalBtn = document.getElementById('closeOralTestTypeModalBtn');
            const selectMidYearOralBtn = document.getElementById('selectMidYearOralBtn');
            const selectEndYearOralBtn = document.getElementById('selectEndYearOralBtn');
            const backToMainTableBtn = document.getElementById('backToMainTableBtn');

            if (oralTestBtn) {
                oralTestBtn.addEventListener('click', () => {
                    if (oralTestBtn.dataset.enabled !== 'true') return;
                    
                    const is6thElementary = currentGradeKey === 'grade6';
                    const is3rdIntermediate = currentGradeKey === 'intermediate3';
                    const is6thSecondary = currentGradeKey?.startsWith('secondary_') && currentGradeKey?.endsWith('_6');
                    const isFinalExamGrade = is6thElementary || is3rdIntermediate || is6thSecondary;

                    selectEndYearOralBtn.disabled = isFinalExamGrade;
                    selectEndYearOralBtn.style.opacity = isFinalExamGrade ? 0.5 : 1;
                    
                    oralTestTypeModal.classList.add('active');
                });
            }

            if (closeOralTestTypeModalBtn) {
                closeOralTestTypeModalBtn.addEventListener('click', () => oralTestTypeModal.classList.remove('active'));
            }

            if (selectMidYearOralBtn) {
                selectMidYearOralBtn.addEventListener('click', () => {
                    currentOralTestType = 'mid-year';
                    renderOralTestTable();
                    oralTestTypeModal.classList.remove('active');
                    navigateToPage('page-oral-test');
                });
            }
            
            if (selectEndYearOralBtn) {
                selectEndYearOralBtn.addEventListener('click', () => {
                    currentOralTestType = 'end-of-year';
                    renderOralTestTable();
                    oralTestTypeModal.classList.remove('active');
                    navigateToPage('page-oral-test');
                });
            }

            if (backToMainTableBtn) {
                backToMainTableBtn.addEventListener('click', () => {
                    saveAppData(); // <<< السطر الجديد والمهم لحفظ البيانات
                    navigateToPage('page-grades-table');
                });
            }

            // --- بداية لوجيك قفل التطبيق ---
            const savedPassword = localStorage.getItem(PASSWORD_KEY);
            if (savedPassword) {
                loginModal.style.display = 'flex'; // استخدام style مباشرة لإظهاره قبل كل شيء

                loginBtn.addEventListener('click', () => {
                    if (loginPasswordInput.value === savedPassword) {
                        loginModal.style.display = 'none';
                        loadAppData(); // تحميل بيانات التطبيق بعد النجاح في تسجيل الدخول
                        navigateToPage(document.querySelector('.page.active')?.id || 'page-main-selection');
                    } else {
                        loginPasswordInput.classList.add('input-error');
                        setTimeout(() => {
                           loginPasswordInput.classList.remove('input-error');
                        }, 500);
                    }
                });
                
                loginPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        loginBtn.click();
                    }
                });

            } else {
                // إذا لم تكن هناك كلمة مرور، قم بتحميل التطبيق كالمعتاد
                loadAppData();
                const initialActivePage = document.querySelector('.page.active');
                navigateToPage(initialActivePage?.id || 'page-main-selection');
            }
            // --- نهاية لوجيك قفل التطبيق ---
            const initialActivePage = document.querySelector('.page.active');
            navigateToPage(initialActivePage?.id || 'page-main-selection'); 
        });
    </script>
    <script>
        // هذا الكود يقوم بتسجيل الـ Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                }).catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
            });
        }
    </script>
</body>
</body>
<div id="oralTestTypeModal" class="modal">
        <div class="modal-content">
             <h3 style="text-align:center; margin-bottom: 20px;">اختر نوع قائمة الشفوي</h3>
             <button id="selectMidYearOralBtn" class="btn btn-stage btn-info" style="font-size: 1.1rem !important;">قائمة نصف السنة</button>
             <button id="selectEndYearOralBtn" class="btn btn-stage btn-warning" style="font-size: 1.1rem !important; color: #333 !important;">قائمة آخر السنة</button>
             <button id="closeOralTestTypeModalBtn" class="btn btn-secondary" style="margin-top: 20px;">إلغاء</button>
        </div>
    </div>


    <div id="page-oral-test" class="page">
        <div class="grades-table-content-wrapper">
            <div class="actions-bar">
                <h2 id="oral-test-table-title" style="color: var(--primary-color); font-size: 1.2rem; margin: 0 auto;"></h2>
                <button id="backToMainTableBtn" class="btn btn-secondary">العودة للجدول الرئيسي</button>
            </div>
            <div class="table-responsive">
                <table id="oralTestTable" class="grades-table">
                    <thead>
                        </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="setPasswordModal" class="modal">
        <div class="modal-content">
            <h3>تعيين / تغيير كلمة المرور</h3>
            <p style="font-size: 0.85rem; text-align: center; color: var(--secondary-color); margin-bottom: 15px;">لإزالة الحماية، اترك الحقول فارغة واضغط حفظ.</p>
            
            <input type="password" id="passwordInput" placeholder="أدخل كلمة المرور الجديدة" style="margin-bottom: 10px;">
            <input type="password" id="confirmPasswordInput" placeholder="تأكيد كلمة المرور" style="margin-bottom: 10px;">
            
            <p id="password-strength-status" style="text-align: center; font-weight: bold; min-height: 20px; transition: color 0.3s ease;"> </p>

            <div class="modal-actions-footer" style="margin-top: 15px;">
                <button id="savePasswordBtn" class="btn btn-success">حفظ</button>
                <button id="cancelSetPasswordBtn" class="btn btn-secondary">إلغاء</button>
            </div>
        </div>
    </div>

    <div id="loginModal" class="modal" style="background-color: var(--bg-color); z-index: 9998; display: none;">
         <div class="modal-content">
            <h3>الرجاء إدخال كلمة المرور</h3>
            <input type="password" id="loginPasswordInput" placeholder="كلمة المرور" style="margin-bottom: 20px;">
            <button id="loginBtn" class="btn btn-primary" style="width: 100%;">دخول</button>
        </div>
    </div>
    </html>